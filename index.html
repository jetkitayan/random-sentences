<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; }

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background-color: #fafafa;
}

/* 上に固定するボタン群 */
#button-area {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 65px 25px 13px 25px;
  text-align: center;
  z-index: 999;
}

/* === 1段目 === */
#button-area .row1 {
  display: flex;
  justify-content: center;   /* 中央寄せ */
  flex-wrap: nowrap;
  gap: 25px;
  margin-bottom: 17px;
  max-width: 900px;          /* 2段目と同じ幅に制限 */
  margin-left: auto;
  margin-right: auto;
}

#button-area .row1 button {
  flex: 1 1 0;
  min-width: 140px;
  max-width: 170px;          /* 幅が広がりすぎない */
}

/* === 2段目 === */
#button-area .row2 {
  display: flex;
  justify-content: center;
  flex-wrap: nowrap;
  margin: 0 auto;
  max-width: 900px;          /* 1段目と同幅 */
}
#button-area .row2 button {
  flex: 1 1 50%;
  min-width: 0;
}

/* 共通ボタン */
button {
  padding: 45px 50px;
  font-size: 40px;
  color: #000;
  border-radius: 16px;
  border: 3px solid #000;
  background-color: #d9d9d9;
  cursor: pointer;
}

/* 2段目の継ぎ目を自然に */
#showStarBtn {
  border-left-width: 1px;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
#showBtn {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

#content {
  margin-top: -15px;
  padding-left: 40px;
  max-width: 900px;
}

#sentence-jp, #sentence-en, #last-shown {
  margin: 40px 0;
}

.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

.top-meta {
  margin: 0;
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 40px;
}
#statsArea table {
  border-collapse: collapse;
  width: 100%;
}
#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
</style>
</head>
<body>

<div id="button-area">
  <div class="row1">
    <button id="okBtn" disabled>OK</button>
    <button id="starBtn" disabled>☆ Star</button>
    <button id="resetBtn">Reset</button>
    <button id="statsBtn">Stats</button>
    <button id="copyBtn">Mail</button>
  </div>

  <div class="row2">
    <button id="showBtn">Show Random</button>
    <button id="showStarBtn">☆ Only</button>
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<div id="statsArea">
  <h3>📊 表示履歴一覧</h3>
  <table>
    <thead>
      <tr>
        <th>日本語</th><th>英語</th><th>YES押下</th><th>☆</th><th>表示回数</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
// ====== 既存JS（前回版の機能含む） ======
let allSentences=[],shownCounts={},yesMarks={},starMarks={},remaining=[],lastShownMap={};
const params=new URLSearchParams(window.location.search);
const fileParam=params.get("file")||"default";
const jsonFile=`${fileParam}.json`;
const keyPrefix=`randomApp_${fileParam}_`;
shownCounts=JSON.parse(localStorage.getItem(keyPrefix+"shownCounts"))||{};
yesMarks=JSON.parse(localStorage.getItem(keyPrefix+"yesMarks"))||{};
starMarks=JSON.parse(localStorage.getItem(keyPrefix+"starMarks"))||{};
remaining=JSON.parse(localStorage.getItem(keyPrefix+"remaining"))||[];
lastShownMap=JSON.parse(localStorage.getItem(keyPrefix+"lastShown"))||{};
let lastShowMode="all";
const todayKey=(new Date()).toISOString().slice(0,10);
const todayCountsKey=keyPrefix+"shownCounts_"+todayKey;
let todayCounts=JSON.parse(localStorage.getItem(todayCountsKey))||{};
const sumCounts=o=>Object.values(o).reduce((a,b)=>a+(b||0),0);
let currentSentence=null,toggleMode=true;
const hourTsKey=keyPrefix+"shownTimestamps";
function loadTs(){try{return JSON.parse(localStorage.getItem(hourTsKey))||[]}catch{return[]}}
function saveTs(a){localStorage.setItem(hourTsKey,JSON.stringify(a))}
function addNowTs(){const n=Date.now();let a=loadTs();a.push(n);a=a.filter(t=>t>=n-86400000);saveTs(a)}
function getLastMinutesCount(m){const n=Date.now(),a=n-m*60000;return loadTs().filter(t=>t>=a).length}
function getLast1HourCount(){return getLastMinutesCount(60)};function getLast5MinCount(){return getLastMinutesCount(5)}
function applyTopPadding(extra=35){const b=document.getElementById('button-area');requestAnimationFrame(()=>{const h=b.getBoundingClientRect().height;document.body.style.paddingTop=(h+extra)+'px';});}
window.addEventListener('load',applyTopPadding);window.addEventListener('resize',()=>applyTopPadding());
fetch(jsonFile).then(r=>{if(!r.ok)throw new Error("ファイルが見つかりません: "+jsonFile);return r.json()}).then(d=>{allSentences=d;if(remaining.length===0)remaining=allSentences.map(s=>s.en);applyTopPadding();}).catch(e=>{document.getElementById("sentence-jp").innerText="❌ JSON読み込み失敗";document.getElementById("sentence-en").innerText=e.message;});
function humanElapsed(i){try{const t=new Date(i).getTime(),s=Math.floor((Date.now()-t)/1000);if(s<60)return`${s}秒前`;const m=Math.floor(s/60);if(m<60)return`${m}分前`;const h=Math.floor(m/60);if(h<24)return`${h}時間前`;return`${Math.floor(h/24)}日前`}catch{return""}}
function pickRandom(p,e){if(!p.length)return null;if(p.length===1)return p[0];let n;do{n=p[Math.floor(Math.random()*p.length)]}while(n===e);return n}
function updateStarUi(){const b=document.getElementById("starBtn");if(!currentSentence){b.disabled=true;b.textContent="☆ Star";return}const e=currentSentence.en,s=!!starMarks[e];b.disabled=false;b.textContent=s?"★ Unstar":"☆ Star";}
function presentSentenceByEn(en){currentSentence=allSentences.find(s=>s.en===en);if(!currentSentence)return;shownCounts[en]=(shownCounts[en]||0)+1;localStorage.setItem(keyPrefix+"shownCounts",JSON.stringify(shownCounts));todayCounts[en]=(todayCounts[en]||0)+1;localStorage.setItem(todayCountsKey,JSON.stringify(todayCounts));addNowTs();const totalShown=sumCounts(shownCounts),today=sumCounts(todayCounts),h1=getLast1HourCount(),h5=getLast5MinCount(),p=lastShownMap[en],pt=p?humanElapsed(p):"なし",star=starMarks[en]?"★":"☆";document.getElementById("sentence-jp").innerHTML=`<div class="top-meta">${star}　${shownCounts[en]}回目<br>${pt}（ ${h5} / ${h1} / ${today} / ${totalShown} ）</div><div>${currentSentence.jp}</div>`;document.getElementById("sentence-en").innerText=currentSentence.en;document.getElementById("okBtn").disabled=false;lastShownMap[en]=new Date().toISOString();localStorage.setItem(keyPrefix+"lastShown",JSON.stringify(lastShownMap));updateStarUi();}
function showRandom(){if(remaining.length===0)return;let en;if(toggleMode){en=pickRandom(remaining,currentSentence?.en)}else{let min=Infinity,least=[];remaining.forEach(s=>{const c=shownCounts[s]||0;if(c<min){min=c;least=[s]}else if(c===min){least.push(s)}});en=pickRandom(least,currentSentence?.en)}toggleMode=!toggleMode;lastShowMode="all";presentSentenceByEn(en);}
function showRandomStarred(){let pool=remaining.filter(e=>!!starMarks[e]);if(pool.length===0)pool=Object.keys(starMarks).filter(e=>starMarks[e]);if(pool.length===0){alert("☆が付いた英文がありません。");return}const en=pickRandom(pool,currentSentence?.en);lastShowMode="star";presentSentenceByEn(en);}
function confirmSentence(){if(!currentSentence)return;yesMarks[currentSentence.en]=true;localStorage.setItem(keyPrefix+"yesMarks",JSON.stringify(yesMarks));remaining=remaining.filter(s=>s!==currentSentence.en);localStorage.setItem(keyPrefix+"remaining",JSON.stringify(remaining));remaining.length>0?showRandom():alert("完了！");}
function toggleStar(){if(!currentSentence)return;const e=currentSentence.en,n=!starMarks[e];starMarks[e]=n;localStorage.setItem(keyPrefix+"starMarks",JSON.stringify(starMarks));updateStarUi();lastShowMode==="star"?showRandomStarred():showRandom();}
function resetData(){if(!confirm("Reset？"))return;localStorage.clear();location.reload();}
function showStats(){const tb=document.getElementById("statsBody");tb.innerHTML="";allSentences.forEach(s=>{const c=shownCounts[s.en]||0,yes=yesMarks[s.en]?"●":"○",star=starMarks[s.en]?"★":"☆";tb.innerHTML+=`<tr><td>${s.en}</td><td>${s.jp}</td><td style='text-align:center;'>${yes}</td><td style='text-align:center;'>${star}</td><td style='text-align:center;'>${c}</td></tr>`});document.getElementById("statsArea").style.display="block";}
function copyStats(){navigator.clipboard.writeText(document.getElementById("statsBody").innerText).then(()=>alert("コピーしました！"));}
document.getElementById("showBtn").onclick=showRandom;
document.getElementById("showStarBtn").onclick=showRandomStarred;
document.getElementById("okBtn").onclick=()=>{if(confirm("OK？"))confirmSentence()};
document.getElementById("resetBtn").onclick=resetData;
document.getElementById("statsBtn").onclick=showStats;
document.getElementById("copyBtn").onclick=copyStats;
document.getElementById("starBtn").onclick=toggleStar;
</script>
</body>
</html>
