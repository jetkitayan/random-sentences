<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; }

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0; /* 上余白はJSで自動調整 */
  background-color: #fafafa;
}

/* 上に固定するボタン群 */
#button-area {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 65px 25px 13px 25px;  /* 上 右 下 左 */
  z-index: 999;
  background: #fafafa;          /* 背景を敷いて重なり時の誤クリックを防止 */
}

/* 中央寄せの共通ラッパー（幅=100%でmax 900px） */
#button-area .wrap {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

/* === 上段：2段目（Show / ☆Only）=== */
#button-area .row2 {
  display: flex;
  gap: 0;                 /* 継ぎ目なし */
  width: 100%;
}
#button-area .row2 button {
  flex: 1 1 0;            /* 左右1/2ずつ均等 */
  min-width: 0;           /* はみ出し防止（長いテキストでも折り返し優先） */
}

/* 継ぎ目を自然に */
#showStarBtn {                 /* 右半分（☆ Only） */
  border-left-width: 1px;      /* 真ん中の線が太くなりすぎないように */
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
#showBtn {                     /* 左半分（Show Random） */
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

/* === 下段：1段目（OK/☆/Reset/Stats/Mail）=== */
#button-area .row1 {
  margin-top: 17px;
  display: flex;
  justify-content: center; /* 中央寄せ */
  align-items: stretch;
  gap: 25px;
  width: 100%;
}
#button-area .row1 button {
  flex: 0 1 160px;        /* 基本160px、狭い時は少し縮む */
  max-width: 160px;
  min-width: 120px;       /* ちょい縮んでも崩れにくくする */
  text-align: center;
}

/* 共通ボタン（文字を水平＆垂直センター） */
button {
  padding: 45px 50px;
  font-size: clamp(24px, 5vw, 40px);  /* 画面に合わせて自動縮小 */
  color: #000;
  border-radius: 16px;
  cursor: pointer;
  border: 3px solid #000;
  background: #fff;
  background-color: #d9d9d9;

  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

/* 旧シングル時代の高さ指定はそのまま利用（縦だけ） */
#showBtn { padding: 80px; }

/* コンテンツ幅もボタンと合わせると見た目が揃う */
#content {
  margin-top: -15px;  /* ベース余白（上はJSで加算） */
  width: 100%;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  padding: 0 0;       /* 左右はwrap側で中央寄せ */
}

/* —— 3行の上下マージンを統一 —— */
#sentence-jp,
#sentence-en,
#last-shown {
  margin: 40px 0;
}

/* 文字サイズなどは従来通り（jp/enのみ共通指定） */
.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

/* 1行目内の補足メタの下余白で1行目と2行目の間隔を作る */
.top-meta {
  margin: 0;
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 0;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

#statsArea table {
  border-collapse: collapse;
  width: 100%;
}

#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* スマホ対応：極端に狭い時は1段目を折り返し */
@media (max-width: 720px) {
  #button-area .row1 {
    flex-wrap: wrap;
    justify-content: center;
  }
  #button-area .row1 button {
    flex: 1 1 45%;
    min-width: 0;
    max-width: none;
  }
}
</style>
</head>
<body>

<div id="button-area">
  <div class="wrap">
    <!-- 上段：2段目（Show / ☆Only） -->
    <div class="row2">
      <button id="showBtn">Show Random</button>
      <button id="showStarBtn">☆ Only</button>
    </div>

    <!-- 下段：1段目（OK/☆/Reset/Stats/Mail） -->
    <div class="row1">
      <button id="okBtn" disabled>OK</button>
      <!-- ☆ボタンは見た目を常に「☆」固定 -->
      <button id="starBtn" disabled>☆</button>
      <button id="resetBtn">Reset</button>
      <button id="statsBtn">Stats</button>
      <button id="copyBtn">Mail</button>
    </div>
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<!-- 表示履歴一覧 -->
<div id="statsArea">
  <h3>📊 表示履歴一覧</h3>
  <table>
    <thead>
      <tr>
        <th>日本語</th>
        <th>英語</th>
        <th>YES押下</th>
        <th>☆</th>
        <th>表示回数</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
/* ========= 状態 ========= */
let allSentences = [];
const params = new URLSearchParams(window.location.search);
const fileParam = params.get("file") || "default";
const jsonFile = `${fileParam}.json`;
const keyPrefix = `randomApp_${fileParam}_`;

/* 永続データのロード */
let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
let starMarks   = JSON.parse(localStorage.getItem(keyPrefix + "starMarks")) || {};
let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

let lastShowMode = "all"; // "all" | "star"

/* 今日カウント */
function getTodayYMD() {
  const now = new Date();
  const tz = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  const y = tz.getFullYear();
  const m = String(tz.getMonth() + 1).padStart(2, '0');
  const d = String(tz.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
const todayKey = getTodayYMD();
const todayCountsKey = keyPrefix + "shownCounts_" + todayKey;
let todayCounts = JSON.parse(localStorage.getItem(todayCountsKey)) || {};

/* キャッシュ集計 */
let totalShownCached = Object.values(shownCounts).reduce((a,b)=>a+(b||0),0);
let todayShownCached = Object.values(todayCounts).reduce((a,b)=>a+(b||0),0);

/* 直近タイムスタンプ */
const hourTsKey = keyPrefix + "shownTimestamps";

/* 画面状態 */
let currentSentence = null;
let toggleMode = true; // true: ランダム / false: 最少回数

/* ========= ユーティリティ ========= */
function loadTs(){ try{ const a=JSON.parse(localStorage.getItem(hourTsKey)); return Array.isArray(a)?a:[] } catch { return [] } }
function saveTs(a){ localStorage.setItem(hourTsKey, JSON.stringify(a)) }
function addNowTs(){
  const now = Date.now();
  let a = loadTs();
  a.push(now);
  const keepAfter = now - 24*60*60*1000;
  if (a.length > 1200) a = a.filter(t => t >= keepAfter);
  saveTs(a);
}
function getLastMinutesCount(min){
  const now = Date.now();
  const after = now - min*60*1000;
  return loadTs().filter(t => t >= after).length;
}
const getLast1HourCount = ()=>getLastMinutesCount(60);
const getLast5MinCount  = ()=>getLastMinutesCount(5);

function applyTopPadding(extra=35){
  const buttonArea = document.getElementById('button-area');
  requestAnimationFrame(()=>{
    const h = buttonArea.getBoundingClientRect().height;
    document.body.style.paddingTop = (h+extra)+'px';
  });
}
window.addEventListener('load', applyTopPadding);
window.addEventListener('resize', ()=>applyTopPadding());

function humanElapsed(iso){
  try{
    const t=new Date(iso).getTime(), s=Math.floor((Date.now()-t)/1000);
    if(s<60) return `${s}秒前`;
    const m=Math.floor(s/60); if(m<60) return `${m}分前`;
    const h=Math.floor(m/60); if(h<24) return `${h}時間前`;
    return `${Math.floor(h/24)}日前`;
  }catch{return""}
}
function pickRandom(pool, excludeEn){
  if (!Array.isArray(pool) || pool.length===0) return null;
  if (pool.length===1) return pool[0];
  let en;
  do { en = pool[Math.floor(Math.random()*pool.length)] } while (en===excludeEn);
  return en;
}

/* localStorage スロットリング */
const pendingSaves = new Map(); // key -> stringified value
let saveScheduled = false;
function scheduleSave(key, obj) {
  pendingSaves.set(key, JSON.stringify(obj));
  if (!saveScheduled) {
    saveScheduled = true;
    Promise.resolve().then(() => {
      pendingSaves.forEach((val, k) => localStorage.setItem(k, val));
      pendingSaves.clear();
      saveScheduled = false;
    });
  }
}

/* en → sentence のマップ */
const byEn = Object.create(null);

/* ========= データ読み込み ========= */
fetch(jsonFile)
  .then(r => { if(!r.ok) throw new Error(`ファイルが見つかりません: ${jsonFile}`); return r.json(); })
  .then(data => {
    allSentences = data;
    for (const s of allSentences) byEn[s.en] = s;
    if (remaining.length === 0) remaining = allSentences.map(s=>s.en);
    applyTopPadding();
  })
  .catch(err => {
    document.getElementById("sentence-jp").textContent = "❌ JSONファイルの読み込みに失敗しました。";
    document.getElementById("sentence-en").textContent = err.message;
  });

/* ========= スターUI（☆固定表示） ========= */
function updateStarUi(){
  const starBtn = document.getElementById("starBtn");
  if (!currentSentence) {
    starBtn.disabled = true;
  } else {
    starBtn.disabled = false;
  }
  // 見た目は常に☆固定
  starBtn.textContent = "☆";
}

/* ========= 表示の共通処理（☆バッジ非表示版） ========= */
function presentSentenceByEn(en){
  const s = byEn[en];
  if (!s) return;
  currentSentence = s;

  // カウント更新
  const newShown = (shownCounts[en]||0) + 1;
  shownCounts[en] = newShown;
  scheduleSave(keyPrefix+"shownCounts", shownCounts);
  totalShownCached++;

  todayCounts[en] = (todayCounts[en]||0) + 1;
  scheduleSave(todayCountsKey, todayCounts);
  todayShownCached++;

  addNowTs();

  const prevIso = lastShownMap[en];
  const prevText = prevIso ? humanElapsed(prevIso) : "なし";
  lastShownMap[en] = new Date().toISOString();
  scheduleSave(keyPrefix+"lastShown", lastShownMap);

  const totalShownLastHour = getLast1HourCount();
  const totalShownLast5Min = getLast5MinCount();

  /* ☆バッジは表示しない */
  document.getElementById("sentence-jp").innerHTML =
    `<div class="top-meta">
       ${newShown}回目<br>${prevText}（ ${totalShownLast5Min} / ${totalShownLastHour} / ${todayShownCached} / ${totalShownCached} ）
     </div>
     <div>${s.jp}</div>`;
  document.getElementById("sentence-en").textContent = s.en;
  document.getElementById("okBtn").disabled = false;

  updateStarUi();
}

/* ========= 通常ランダム表示 ========= */
function showRandom(){
  if (remaining.length === 0) {
    document.getElementById("sentence-jp").textContent = "すべての英文を表示しました！";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
    return;
  }

  let en;
  if (toggleMode) {
    en = pickRandom(remaining, currentSentence?.en);
  } else {
    let min = Infinity, least = [];
    for (const s of remaining) {
      const c = (shownCounts[s] || 0);
      if (c < min) { min = c; least.length = 0; least.push(s); }
      else if (c === min) { least.push(s); }
    }
    en = pickRandom(least, currentSentence?.en);
  }
  toggleMode = !toggleMode;

  lastShowMode = "all";
  presentSentenceByEn(en);
}

/* ========= ☆のみランダム表示 ========= */
function showRandomStarred(){
  let pool = remaining.filter(en => !!starMarks[en]);
  if (pool.length === 0) {
    pool = Object.keys(starMarks).filter(en => starMarks[en]);
  }
  if (pool.length === 0) {
    alert("☆が付いた英文がありません。先に『☆』でお気に入り登録してください。");
    return;
  }
  const en = pickRandom(pool, currentSentence?.en);
  lastShowMode = "star";
  presentSentenceByEn(en);
}

/* ========= OK確定 ========= */
function confirmSentence(){
  if (!currentSentence) return;
  yesMarks[currentSentence.en] = true;
  scheduleSave(keyPrefix + "yesMarks", yesMarks);

  remaining = remaining.filter(s => s !== currentSentence.en);
  scheduleSave(keyPrefix + "remaining", remaining);

  if (remaining.length > 0) showRandom();
  else {
    document.getElementById("sentence-jp").textContent = "すべての英文を表示しました！";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
  }
}

/* ========= ☆トグル（押したら次へ／見た目は☆固定） ========= */
function toggleStar(){
  if (!currentSentence) return;
  const en = currentSentence.en;
  const now = !starMarks[en];
  starMarks[en] = now;
  scheduleSave(keyPrefix + "starMarks", starMarks);

  updateStarUi();  // ラベルは常に「☆」

  if (lastShowMode === "star") showRandomStarred();
  else showRandom();
}

/* ========= リセット ========= */
function clearDailyCounts(){
  const prefix = keyPrefix + "shownCounts_";
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const k = localStorage.key(i);
    if (k && k.startsWith(prefix)) localStorage.removeItem(k);
  }
}
function resetData(){
  if (!confirm("Reset？")) return;
  localStorage.removeItem(keyPrefix+"shownCounts");
  localStorage.removeItem(keyPrefix+"remaining");
  localStorage.removeItem(keyPrefix+"yesMarks");
  localStorage.removeItem(keyPrefix+"lastShown");
  localStorage.removeItem(keyPrefix+"starMarks");
  localStorage.removeItem(hourTsKey);
  clearDailyCounts();

  shownCounts = {}; yesMarks = {}; lastShownMap = {}; starMarks = {};
  totalShownCached = 0; todayShownCached = 0;
  todayCounts = {}; localStorage.removeItem(todayCountsKey);

  remaining = allSentences.map(s=>s.en); currentSentence = null;
  document.getElementById("sentence-jp").textContent = "Press 'Show Random' to start";
  document.getElementById("sentence-en").textContent = "";
  document.getElementById("last-shown").textContent = "";
  document.getElementById("showBtn").disabled = false;
  document.getElementById("okBtn").disabled = true;
  document.getElementById("starBtn").disabled = true;
  document.getElementById("statsArea").style.display = "none";
  applyTopPadding();
}

/* ========= Stats & Copy ========= */
function showStats(){
  const tbody = document.getElementById("statsBody");
  tbody.innerHTML = "";
  for (const s of allSentences) {
    const c = shownCounts[s.en] || 0;
    const yes = yesMarks[s.en] ? "●" : "○";
    const star = starMarks[s.en] ? "★" : "☆";
    tbody.innerHTML += `
      <tr>
        <td>${s.en}</td>
        <td>${s.jp}</td>
        <td style="text-align:center;">${yes}</td>
        <td style="text-align:center;">${star}</td>
        <td style="text-align:center;">${c}</td>
      </tr>`;
  }
  document.getElementById("statsArea").style.display = "block";
}
function copyStats(){
  const table = document.querySelector("#statsArea table");
  if (!table) { alert("一覧が表示されていません。"); return; }
  let text = "";
  table.querySelectorAll("tr").forEach(tr => {
    const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
    text += cols.join("@") + "\n";
  });
  navigator.clipboard.writeText(text)
    .then(()=>alert("一覧をコピーしました！ これからメール作成画面を開きます。"))
    .catch(()=>alert("コピーに失敗しました。もう一度お試しください。"));
}

/* ========= イベント ========= */
document.getElementById("showBtn").onclick = showRandom;
document.getElementById("showStarBtn").onclick = showRandomStarred;
document.getElementById("okBtn").onclick = () => { if (!currentSentence) return; if (confirm("OK？")) confirmSentence(); };
document.getElementById("resetBtn").onclick = resetData;
document.getElementById("statsBtn").onclick = showStats;
document.getElementById("copyBtn").onclick = copyStats;
document.getElementById("starBtn").onclick = toggleStar;
</script>
</body>
</html>
