<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Random English Sentences</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0; /* ä¸Šä½™ç™½ã¯JSã§è‡ªå‹•èª¿æ•´ */
      background-color: #fafafa;
    }

    /* ä¸Šã«å›ºå®šã™ã‚‹ãƒœã‚¿ãƒ³ç¾¤ */
    #button-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 60px 13px;           /* å¿…è¦ãªã‚‰å°ã•ãã—ã¦OK */
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      text-align: center;
      z-index: 999;
    }

    .button-row {
      display: flex;
      justify-content: center;
      gap: 25px;
    }

    button {
      padding: 60px 60px;           /* å¿…è¦ãªã‚‰ 14px 22px ãªã©ã« */
      font-size: 32px;              /* å¿…è¦ãªã‚‰ 22px ãªã©ã« */
      margin: 25px 5px;
      border-radius: 16px;
      cursor: pointer;
    }

    #content {
      margin-top: 20px;             /* ãƒ™ãƒ¼ã‚¹ä½™ç™½ï¼ˆä¸Šã¯JSã§åŠ ç®—ï¼‰ */
      padding-left: 40px;
      max-width: 900px;
    }

    .count-label,
    #sentence-jp,
    #sentence-en {
      margin: 50px 0;
      line-height: 1.6;
      font-size: 48px;
      color: #000;
    }

    #last-shown {
      margin-top: 16px;
      font-size: 48px;
      color: #555;
    }

    #statsArea {
      display: none;
      padding: 20px 40px;
    }

    #statsArea table {
      border-collapse: collapse;
      width: 100%;
    }

    #statsArea th, #statsArea td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    .top-meta { margin-bottom: 50px; }
  </style>
</head>
<body>

  <!-- å¸¸ã«ä¸Šå›ºå®šã®ãƒœã‚¿ãƒ³ç¾¤ -->
  <div id="button-area">
    <div class="button-row">
      <button id="showBtn">Show Random</button>
      <button id="okBtn" disabled>OK (YES)</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div class="button-row">
      <button id="statsBtn">Show Stats</button>
      <button id="copyBtn">Copy Stats</button>
    </div>
  </div>

  <div id="content">
    <div id="sentence-jp">Press "Show Random" to start</div>
    <div id="sentence-en"></div>
    <div id="last-shown"></div>
  </div>

  <!-- è¡¨ç¤ºå±¥æ­´ä¸€è¦§ -->
  <div id="statsArea">
    <h3>ğŸ“Š è¡¨ç¤ºå±¥æ­´ä¸€è¦§</h3>
    <table>
      <thead>
        <tr>
          <th>æ—¥æœ¬èª</th>
          <th>è‹±èª</th>
          <th>YESæŠ¼ä¸‹</th>
          <th>è¡¨ç¤ºå›æ•°</th>
        </tr>
      </thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <script>
  // ====== åˆæœŸåŒ– ======
  let allSentences = [];
  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get("file") || "default";
  const jsonFile = `${fileParam}.json`;

  const keyPrefix = `randomApp_${fileParam}_`;

  let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
  let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
  let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
  let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

  let currentSentence = null;
  let toggleMode = true; // true: ãƒ©ãƒ³ãƒ€ãƒ  / false: æœ€å°‘å›æ•°

  // ====== ä¸Šå›ºå®šã®ãŸã‚ã®è‡ªå‹•ä½™ç™½èª¿æ•´ ======
  function applyTopPadding(extra = 40) { // ä½™è£•ã‚’å°‘ã—è¶³ã™
    const buttonArea = document.getElementById('button-area');
    requestAnimationFrame(() => {
      const h = buttonArea.getBoundingClientRect().height;
      document.body.style.paddingTop = (h + extra) + 'px';
    });
  }
  window.addEventListener('load', applyTopPadding);
  window.addEventListener('resize', () => applyTopPadding());

  // ====== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
  fetch(jsonFile)
    .then(r => { if (!r.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${jsonFile}`); return r.json(); })
    .then(data => {
      allSentences = data;
      if (remaining.length === 0) remaining = allSentences.map(s => s.en);
      applyTopPadding(); // æŠ˜ã‚Šè¿”ã—ã§é«˜ã•ãŒå¤‰ã‚ã‚‹å ´åˆã«å‚™ãˆã¦
    })
    .catch(err => {
      document.getElementById("sentence-jp").innerText = "âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      document.getElementById("sentence-en").innerText = err.message;
    });

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const formatJp = iso => { try { return new Date(iso).toLocaleString("ja-JP",{ timeZone:"Asia/Tokyo" }); } catch { return iso||""; } };
  function humanElapsed(iso){ try{const t=new Date(iso).getTime(),s=Math.floor((Date.now()-t)/1000); if(s<60)return`${s}ç§’å‰`; const m=Math.floor(s/60); if(m<60)return`${m}åˆ†å‰`; const h=Math.floor(m/60); if(h<24)return`${h}æ™‚é–“å‰`; const d=Math.floor(h/24); return`${d}æ—¥å‰`;}catch{return"";} }

  // ====== è¡¨ç¤ºå‡¦ç† ======
  function showRandom() {
    const lastShownDiv = document.getElementById("last-shown");
    if (remaining.length === 0) {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      lastShownDiv.textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
      return;
    }

    let en;
    if (toggleMode) {
      en = remaining[Math.floor(Math.random() * remaining.length)];
    } else {
      let min = Infinity, least = [];
      remaining.forEach(s => {
        const c = shownCounts[s] || 0;
        if (c < min) { min = c; least = [s]; }
        else if (c === min) { least.push(s); }
      });
      en = least[Math.floor(Math.random() * least.length)];
    }
    toggleMode = !toggleMode;

    currentSentence = allSentences.find(s => s.en === en);
    shownCounts[en] = (shownCounts[en] || 0) + 1;
    localStorage.setItem(keyPrefix + "shownCounts", JSON.stringify(shownCounts));
    const totalShown = Object.values(shownCounts).reduce((a,b)=>a+b,0);

    document.getElementById("sentence-jp").innerHTML = `
      <div class="top-meta">${shownCounts[en]}å›ç›® ï¼ˆç·å›æ•°: ${totalShown}ï¼‰</div>
      <div>${currentSentence.jp}</div>`;
    document.getElementById("sentence-en").innerText = currentSentence.en;
    document.getElementById("okBtn").disabled = false;

    const prevIso = lastShownMap[en];
    document.getElementById("last-shown").textContent =
      prevIso ? `${humanElapsed(prevIso)}` : "åˆå›è¡¨ç¤º";
    lastShownMap[en] = new Date().toISOString();
    localStorage.setItem(keyPrefix + "lastShown", JSON.stringify(lastShownMap));
  }

  function confirmSentence() {
    if (!currentSentence) return;
    yesMarks[currentSentence.en] = true;
    localStorage.setItem(keyPrefix + "yesMarks", JSON.stringify(yesMarks));
    remaining = remaining.filter(s => s !== currentSentence.en);
    localStorage.setItem(keyPrefix + "remaining", JSON.stringify(remaining));
    if (remaining.length > 0) showRandom();
    else {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      document.getElementById("last-shown").textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
    }
  }

  function resetData() {
    if (!confirm("Reset all data?")) return;
    localStorage.removeItem(keyPrefix + "shownCounts");
    localStorage.removeItem(keyPrefix + "remaining");
    localStorage.removeItem(keyPrefix + "yesMarks");
    localStorage.removeItem(keyPrefix + "lastShown");
    shownCounts = {}; yesMarks = {}; lastShownMap = {};
    remaining = allSentences.map(s => s.en); currentSentence = null;
    document.getElementById("sentence-jp").innerText = "Press 'Show Random' to start";
    document.getElementById("sentence-en").innerText = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = false;
    document.getElementById("statsArea").style.display = "none";
    applyTopPadding();
  }

  function showStats() {
    const tbody = document.getElementById("statsBody");
    tbody.innerHTML = "";
    allSentences.forEach(s => {
      const c = shownCounts[s.en] || 0;
      const yes = yesMarks[s.en] ? "â—" : "â—‹";
      tbody.innerHTML += `
        <tr>
          <td>${s.en}</td>
          <td>${s.jp}</td>
          <td style="text-align:center;">${yes}</td>
          <td style="text-align:center;">${c}</td>
        </tr>`;
    });
    document.getElementById("statsArea").style.display = "block";
  }

  function copyStats() {
  const table = document.querySelector("#statsArea table");
  if (!table) {
    alert("ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–
  let text = "";
  table.querySelectorAll("tr").forEach(tr => {
    const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
    text += cols.join("@") + "\n";
  });

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼
  navigator.clipboard.writeText(text)
    .then(() => {
      alert("ä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ ã“ã‚Œã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™ã€‚");

      // ä»¶åãƒ»æœ¬æ–‡ã‚’ä½œæˆï¼ˆmailtoã®URLåˆ¶é™å¯¾ç­–ã§å°‘ã—çŸ­ãï¼‰
      const to = "jetkitayan@gmai.com"; // å¿…è¦ãªã‚‰ gmail.com ã«ç›´ã—ã¦ãã ã•ã„
      const subject = "Random English Sentences - Stats";
      const limit = 1800; // URLæ–‡å­—æ•°ã®å®‰å…¨ãƒ©ã‚¤ãƒ³ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šå‰å¾Œï¼‰
      let body = text;
      if (body.length > limit) {
        body = body.slice(0, limit) + "\n...\n(æœ¬æ–‡ãŒé•·ã„ãŸã‚é€”ä¸­ã¾ã§ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã¯å…¨é‡ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚)";
      }

      // mailto ã§ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãï¼ˆã¾ãŸã¯ Gmail ã®æ–°è¦ä½œæˆç”»é¢ã§ã‚‚OKï¼‰
      const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      // ãƒšãƒ¼ã‚¸é·ç§»ã‚’é¿ã‘ã‚‹ãŸã‚åˆ¥ã‚¿ãƒ–/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§
      window.open(mailtoUrl, "_blank");
    })
    .catch(() => {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    });
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  document.getElementById("showBtn").onclick = showRandom;
  document.getElementById("okBtn").onclick = confirmSentence;
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("statsBtn").onclick = showStats;
  document.getElementById("copyBtn").onclick = copyStats;
  </script>
</body>
</html>




