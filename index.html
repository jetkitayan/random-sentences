<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; } /* 幅計算の誤差防止 */

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0; /* 上余白はJSで自動調整 */
  background-color: #fafafa;
}

/* 上に固定するボタン群（左右25pxに統一） */
#button-area {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-bottom: 10px double #ddd;
  box-shadow: 0 6px 10px rgba(0,0,0,0.1);
  padding: 33px 25px;         /* ← 左右25pxに統一（ズレ解消） */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  text-align: center;
  z-index: 999;
}

/* 1段目＝Show Random を横幅いっぱい（横マージンは使わない） */
#button-area .row1 {
  display: flex;
  margin-bottom: 23px;
}
#button-area .row1 button {
  flex: 1 1 auto;
  width: 100%;
  margin: 0;                  /* ← 横方向のマージンを排除 */
}

/* 2段目＝1段目と左右幅を完全一致＋1行固定 */
#button-area .row2 {
  display: flex;
  justify-content: space-between;
  gap: 25px;
  flex-wrap: nowrap;          /* ← 折り返し禁止 */
  flex-shrink: 1;
  margin: 0;                  /* ← 外側マージンを持たせない */
}

/* 2段目の各ボタンを少し広めに */
#button-area .row2 button {
  flex: 1 1 200px;            /* 目安：やや広め */
  min-width: 180px;
}

/* ボタン共通（高さはここで調整） */
button {
  padding: 55px 50px;         /* 必要なら 80px 60px などに */
  font-size: 40px;
  margin: 13px 0;             /* ← 横方向は0に固定（ズレ要因を排除） */
  border-radius: 16px;
  cursor: pointer;
}

#content {
  margin-top: -5px;           /* ベース余白（上はJSで加算） */
  padding-left: 40px;
  max-width: 900px;
}

/* —— 3行の上下マージンを統一 —— */
#sentence-jp,
#sentence-en,
#last-shown {
  margin: 40px 0;
}

/* 文字サイズなどは従来通り（jp/enのみ共通指定） */
.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

/* 一行目内の補足メタは外側マージンを持たせない（見た目の隙間はパディングで） */
.top-meta {
  margin: 0;          /* ← もとの 50px を撤回 */
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 40px;
}

#statsArea table {
  border-collapse: collapse;
  width: 100%;
}

#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
</style>
</head>
<body>

<!-- 常に上固定のボタン群 -->
<div id="button-area">
  <!-- 1段目：横幅いっぱいの Show Random -->
  <div class="row1">
    <button id="showBtn">Show Random</button>
  </div>
  <!-- 2段目：他4ボタンを横並び（1行固定） -->
  <div class="row2">
    <button id="okBtn" disabled>OK</button>
    <button id="resetBtn">Reset</button>
    <button id="statsBtn">Stats</button>
    <button id="copyBtn">Mail</button>
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<!-- 表示履歴一覧 -->
<div id="statsArea">
  <h3>📊 表示履歴一覧</h3>
  <table>
    <thead>
      <tr>
        <th>日本語</th>
        <th>英語</th>
        <th>YES押下</th>
        <th>表示回数</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
  // ====== 初期化 ======
  let allSentences = [];
  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get("file") || "default";
  const jsonFile = `${fileParam}.json`;

  const keyPrefix = `randomApp_${fileParam}_`;

  let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
  let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
  let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
  let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

  // --- 今日(Asia/Tokyo) の日付キーと当日カウント（総数算出用） ---
  function getTodayYMD() {
    const now = new Date();
    const tz = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
    const y = tz.getFullYear();
    const m = String(tz.getMonth() + 1).padStart(2, '0');
    const d = String(tz.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  const todayKey = getTodayYMD();
  const todayCountsKey = keyPrefix + "shownCounts_" + todayKey; // 例: randomApp_default_shownCounts_2025-10-19
  let todayCounts = JSON.parse(localStorage.getItem(todayCountsKey)) || {};

  const sumCounts = (obj) => Object.values(obj).reduce((a,b)=>a + (b||0), 0);

  let currentSentence = null;
  let toggleMode = true; // true: ランダム / false: 最少回数

  // ====== NEW: 直近1時間集計用タイムスタンプ配列 ======
  const hourTsKey = keyPrefix + "shownTimestamps"; // 数値(ミリ秒)の配列
  function loadTs() {
    try {
      const arr = JSON.parse(localStorage.getItem(hourTsKey));
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function saveTs(arr) {
    localStorage.setItem(hourTsKey, JSON.stringify(arr));
  }
  function addNowTs() {
    const now = Date.now();
    let arr = loadTs();
    arr.push(now);
    // メモリ節約：24時間より古いものは間引き（必要十分）
    const keepAfter = now - 24 * 60 * 60 * 1000;
    arr = arr.filter(t => typeof t === "number" && t >= keepAfter);
    saveTs(arr);
  }
  function getLast1HourCount() {
    const now = Date.now();
    const after = now - 60 * 60 * 1000;
    return loadTs().filter(t => t >= after).length;
  }

  // ====== 上固定のための自動余白調整 ======
  function applyTopPadding(extra = 35) { // 余裕を少し足す
    const buttonArea = document.getElementById('button-area');
    requestAnimationFrame(() => {
      const h = buttonArea.getBoundingClientRect().height;
      document.body.style.paddingTop = (h + extra) + 'px';
    });
  }
  window.addEventListener('load', applyTopPadding);
  window.addEventListener('resize', () => applyTopPadding());

  // ====== データ読み込み ======
  fetch(jsonFile)
    .then(r => { if (!r.ok) throw new Error(`ファイルが見つかりません: ${jsonFile}`); return r.json(); })
    .then(data => {
      allSentences = data;
      if (remaining.length === 0) remaining = allSentences.map(s => s.en);
      applyTopPadding(); // 折り返しで高さが変わる場合に備えて
    })
    .catch(err => {
      document.getElementById("sentence-jp").innerText = "❌ JSONファイルの読み込みに失敗しました。";
      document.getElementById("sentence-en").innerText = err.message;
    });

  // ====== ユーティリティ ======
  const formatJp = iso => { try { return new Date(iso).toLocaleString("ja-JP",{ timeZone:"Asia/Tokyo" }); } catch { return iso||""; } };
  function humanElapsed(iso){ try{const t=new Date(iso).getTime(),s=Math.floor((Date.now()-t)/1000); if(s<60)return`${s}秒前`; const m=Math.floor(s/60); if(m<60)return`${m}分前`; const h=Math.floor(m/60); if(h<24)return`${h}時間前`; const d=Math.floor(h/24); return`${d}日前`;}catch{return"";} }

  // ====== 表示処理 ======
  function showRandom() {
    const lastShownDiv = document.getElementById("last-shown");
    if (remaining.length === 0) {
      document.getElementById("sentence-jp").innerText = "すべての英文を表示しました！";
      document.getElementById("sentence-en").innerText = "";
      lastShownDiv.textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
      return;
    }
  
    let en;
    if (toggleMode) {
      en = remaining[Math.floor(Math.random() * remaining.length)];
    } else {
      let min = Infinity, least = [];
      remaining.forEach(s => {
        const c = shownCounts[s] || 0;
        if (c < min) { min = c; least = [s]; }
        else if (c === min) { least.push(s); }
      });
      en = least[Math.floor(Math.random() * least.length)];
    }
    toggleMode = !toggleMode;
  
    currentSentence = allSentences.find(s => s.en === en);
  
    // ---- 累計・本日カウントを更新 ----
    shownCounts[en] = (shownCounts[en] || 0) + 1;
    localStorage.setItem(keyPrefix + "shownCounts", JSON.stringify(shownCounts));
  
    todayCounts[en] = (todayCounts[en] || 0) + 1;
    localStorage.setItem(todayCountsKey, JSON.stringify(todayCounts));
  
    // ---- NEW: 直近1時間集計用タイムスタンプを追加 ----
    addNowTs();
  
    // 総表示回数（累計）と、その内「今日」「直近1時間」
    const totalShown = Object.values(shownCounts).reduce((a,b)=>a+b,0);
    const totalShownToday = sumCounts(todayCounts);
    const totalShownLastHour = getLast1HourCount();
  
    // ---- NEW: 前回表示時間の取得 ----
    const prevIso = lastShownMap[en];
    const prevText = prevIso ? humanElapsed(prevIso) : "なし";
  
    // ---- 表示更新 ----
    document.getElementById("sentence-jp").innerHTML = `
      <div class="top-meta">
        ${shownCounts[en]}回目［ ${prevText}（ ${totalShownLastHour} / ${totalShownToday} / ${totalShown} ）］
      </div>
      <div>${currentSentence.jp}</div>`;
    document.getElementById("sentence-en").innerText = currentSentence.en;
    document.getElementById("okBtn").disabled = false;
  
    // 前回時刻を更新
    lastShownMap[en] = new Date().toISOString();
    localStorage.setItem(keyPrefix + "lastShown", JSON.stringify(lastShownMap));
  }
  
  function confirmSentence() {
    if (!currentSentence) return;
    yesMarks[currentSentence.en] = true;
    localStorage.setItem(keyPrefix + "yesMarks", JSON.stringify(yesMarks));
    remaining = remaining.filter(s => s !== currentSentence.en);
    localStorage.setItem(keyPrefix + "remaining", JSON.stringify(remaining));
    if (remaining.length > 0) showRandom();
    else {
      document.getElementById("sentence-jp").innerText = "すべての英文を表示しました！";
      document.getElementById("sentence-en").innerText = "";
      document.getElementById("last-shown").textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
    }
  }

  // --- 当日カウント用キーも含めて全削除 ---
  function clearDailyCounts() {
    const prefix = keyPrefix + "shownCounts_";
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const k = localStorage.key(i);
      if (k && k.startsWith(prefix)) {
        localStorage.removeItem(k);
      }
    }
  }

  function resetData() {
    if (!confirm("Reset all data?")) return;
    localStorage.removeItem(keyPrefix + "shownCounts");
    localStorage.removeItem(keyPrefix + "remaining");
    localStorage.removeItem(keyPrefix + "yesMarks");
    localStorage.removeItem(keyPrefix + "lastShown");
    clearDailyCounts(); // ★日別カウント全削除
    localStorage.removeItem(hourTsKey); // ★直近1時間用タイムスタンプ削除

    shownCounts = {}; yesMarks = {}; lastShownMap = {};
    todayCounts = {}; localStorage.removeItem(todayCountsKey);

    remaining = allSentences.map(s => s.en); currentSentence = null;
    document.getElementById("sentence-jp").innerText = "Press 'Show Random' to start";
    document.getElementById("sentence-en").innerText = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = false;
    document.getElementById("statsArea").style.display = "none";
    applyTopPadding();
  }

  function showStats() {
    const tbody = document.getElementById("statsBody");
    tbody.innerHTML = "";
    allSentences.forEach(s => {
      const c = shownCounts[s.en] || 0;
      const yes = yesMarks[s.en] ? "●" : "○";
      tbody.innerHTML += `
        <tr>
          <td>${s.en}</td>
          <td>${s.jp}</td>
          <td style="text-align:center;">${yes}</td>
          <td style="text-align:center;">${c}</td>
        </tr>`;
    });
    document.getElementById("statsArea").style.display = "block";
  }

  function copyStats() {
    const table = document.querySelector("#statsArea table");
    if (!table) {
      alert("一覧が表示されていません。");
      return;
    }

    // テーブルをテキスト化
    let text = "";
    table.querySelectorAll("tr").forEach(tr => {
      const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
      text += cols.join("@") + "\n";
    });

    // クリップボードへコピー
    navigator.clipboard.writeText(text)
      .then(() => {
        alert("一覧をコピーしました！ これからメール作成画面を開きます。");

        // 件名・本文を作成（本文は空欄）
        const to = "jetkitayan@gmail.com";
        const subject = "Random English Sentences - Stats";
        const body = "";

        // mailto でメール作成画面を開く
        const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoUrl, "_blank");
      })
      .catch(() => {
        alert("コピーに失敗しました。もう一度お試しください。");
      });
  }

  // イベント登録
  document.getElementById("showBtn").onclick = showRandom;
  document.getElementById("okBtn").onclick = confirmSentence;
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("statsBtn").onclick = showStats;
  document.getElementById("copyBtn").onclick = copyStats;
</script>
</body>
</html>






















































