<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; }

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0; /* ä¸Šä½™ç™½ã¯JSã§è‡ªå‹•èª¿æ•´ */
  background-color: #fafafa;
}

/* ä¸Šã«å›ºå®šã™ã‚‹ãƒœã‚¿ãƒ³ç¾¤ */
#button-area {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 65px 25px 13px 25px;  /* ä¸Š å³ ä¸‹ å·¦ */
  z-index: 999;
  background: #fafafa;          /* èƒŒæ™¯ã‚’æ•·ã„ã¦é‡ãªã‚Šæ™‚ã®èª¤ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢ */
}

/* ä¸­å¤®å¯„ã›ã®å…±é€šãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå¹…=100%ã§max 900pxï¼‰ */
#button-area .wrap {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

/* === ä¸Šæ®µï¼š2æ®µç›®ï¼ˆShow / â˜†Onlyï¼‰=== */
#button-area .row2 {
  display: flex;
  gap: 0;                 /* ç¶™ãç›®ãªã— */
  width: 100%;
}
#button-area .row2 button {
  flex: 1 1 0;            /* å·¦å³1/2ãšã¤å‡ç­‰ */
  min-width: 0;           /* ã¯ã¿å‡ºã—é˜²æ­¢ï¼ˆé•·ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚æŠ˜ã‚Šè¿”ã—å„ªå…ˆï¼‰ */
}

/* ç¶™ãç›®ã‚’è‡ªç„¶ã« */
#showStarBtn {                 /* å³åŠåˆ†ï¼ˆâ˜† Onlyï¼‰ */
  border-left-width: 1px;      /* çœŸã‚“ä¸­ã®ç·šãŒå¤ªããªã‚Šã™ããªã„ã‚ˆã†ã« */
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
#showBtn {                     /* å·¦åŠåˆ†ï¼ˆShow Randomï¼‰ */
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

/* === ä¸‹æ®µï¼š1æ®µç›®ï¼ˆOK/â˜†/Reset/Stats/Mailï¼‰=== */
#button-area .row1 {
  margin-top: 17px;
  display: flex;
  justify-content: center; /* ä¸­å¤®å¯„ã› */
  align-items: stretch;
  gap: 25px;
  width: 100%;
}
#button-area .row1 button {
  flex: 0 1 160px;        /* åŸºæœ¬160pxã€ç‹­ã„æ™‚ã¯å°‘ã—ç¸®ã‚€ */
  max-width: 160px;
  min-width: 120px;       /* ã¡ã‚‡ã„ç¸®ã‚“ã§ã‚‚å´©ã‚Œã«ããã™ã‚‹ */
  text-align: center;
}

/* å…±é€šãƒœã‚¿ãƒ³ï¼ˆæ–‡å­—ã‚’æ°´å¹³ï¼†å‚ç›´ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ */
button {
  padding: 45px 50px;
  font-size: clamp(24px, 5vw, 40px);  /* ç”»é¢ã«åˆã‚ã›ã¦è‡ªå‹•ç¸®å° */
  color: #000;
  border-radius: 16px;
  cursor: pointer;
  border: 3px solid #000;
  background: #fff;
  background-color: #d9d9d9;

  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

/* æ—§ã‚·ãƒ³ã‚°ãƒ«æ™‚ä»£ã®é«˜ã•æŒ‡å®šã¯ãã®ã¾ã¾åˆ©ç”¨ï¼ˆç¸¦ã ã‘ï¼‰ */
#showBtn { padding: 80px; }

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚‚ãƒœã‚¿ãƒ³ã¨åˆã‚ã›ã‚‹ã¨è¦‹ãŸç›®ãŒæƒã† */
#content {
  margin-top: -15px;  /* ãƒ™ãƒ¼ã‚¹ä½™ç™½ï¼ˆä¸Šã¯JSã§åŠ ç®—ï¼‰ */
  width: 100%;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  padding: 0 0;       /* å·¦å³ã¯wrapå´ã§ä¸­å¤®å¯„ã› */
}

/* â€”â€” 3è¡Œã®ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’çµ±ä¸€ â€”â€” */
#sentence-jp,
#sentence-en,
#last-shown {
  margin: 40px 0;
}

/* æ–‡å­—ã‚µã‚¤ã‚ºãªã©ã¯å¾“æ¥é€šã‚Šï¼ˆjp/enã®ã¿å…±é€šæŒ‡å®šï¼‰ */
.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

/* 1è¡Œç›®å†…ã®è£œè¶³ãƒ¡ã‚¿ã®ä¸‹ä½™ç™½ã§1è¡Œç›®ã¨2è¡Œç›®ã®é–“éš”ã‚’ä½œã‚‹ */
.top-meta {
  margin: 0;
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 0;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

#statsArea table {
  border-collapse: collapse;
  width: 100%;
}

#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œï¼šæ¥µç«¯ã«ç‹­ã„æ™‚ã¯1æ®µç›®ã‚’æŠ˜ã‚Šè¿”ã— */
@media (max-width: 720px) {
  #button-area .row1 {
    flex-wrap: wrap;
    justify-content: center;
  }
  #button-area .row1 button {
    flex: 1 1 45%;
    min-width: 0;
    max-width: none;
  }
}
</style>
</head>
<body>

<div id="button-area">
  <div class="wrap">
    <!-- ä¸Šæ®µï¼š2æ®µç›®ï¼ˆShow / â˜†Onlyï¼‰ -->
    <div class="row2">
      <button id="showBtn">Show Random</button>
      <button id="showStarBtn">â˜† Only</button>
    </div>

    <!-- ä¸‹æ®µï¼š1æ®µç›®ï¼ˆOK/â˜†/Reset/Stats/Mailï¼‰ -->
    <div class="row1">
      <button id="okBtn" disabled>OK</button>
      <!-- â˜†ãƒœã‚¿ãƒ³ã¯è¦‹ãŸç›®ã‚’å¸¸ã«ã€Œâ˜†ã€å›ºå®š -->
      <button id="starBtn" disabled>â˜†</button>
      <button id="resetBtn">Reset</button>
      <button id="statsBtn">Stats</button>
      <button id="copyBtn">Mail</button>
    </div>
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<!-- è¡¨ç¤ºå±¥æ­´ä¸€è¦§ -->
<div id="statsArea">
  <h3>ğŸ“Š è¡¨ç¤ºå±¥æ­´ä¸€è¦§</h3>
  <table>
    <thead>
      <tr>
        <th>æ—¥æœ¬èª</th>
        <th>è‹±èª</th>
        <th>YESæŠ¼ä¸‹</th>
        <th>â˜†</th>
        <th>è¡¨ç¤ºå›æ•°</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
/* ========= çŠ¶æ…‹ ========= */
let allSentences = [];
const params = new URLSearchParams(window.location.search);
const fileParam = params.get("file") || "default";
const jsonFile = `${fileParam}.json`;
const keyPrefix = `randomApp_${fileParam}_`;

/* æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ */
let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
let starMarks   = JSON.parse(localStorage.getItem(keyPrefix + "starMarks")) || {};
let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

let lastShowMode = "all"; // "all" | "star"

/* ä»Šæ—¥ã‚«ã‚¦ãƒ³ãƒˆ */
function getTodayYMD() {
  const now = new Date();
  const tz = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  const y = tz.getFullYear();
  const m = String(tz.getMonth() + 1).padStart(2, '0');
  const d = String(tz.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
const todayKey = getTodayYMD();
const todayCountsKey = keyPrefix + "shownCounts_" + todayKey;
let todayCounts = JSON.parse(localStorage.getItem(todayCountsKey)) || {};

/* ã‚­ãƒ£ãƒƒã‚·ãƒ¥é›†è¨ˆ */
let totalShownCached = Object.values(shownCounts).reduce((a,b)=>a+(b||0),0);
let todayShownCached = Object.values(todayCounts).reduce((a,b)=>a+(b||0),0);

/* ç›´è¿‘ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— */
const hourTsKey = keyPrefix + "shownTimestamps";

/* ç”»é¢çŠ¶æ…‹ */
let currentSentence = null;
let toggleMode = true; // true: ãƒ©ãƒ³ãƒ€ãƒ  / false: æœ€å°‘å›æ•°

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function loadTs(){ try{ const a=JSON.parse(localStorage.getItem(hourTsKey)); return Array.isArray(a)?a:[] } catch { return [] } }
function saveTs(a){ localStorage.setItem(hourTsKey, JSON.stringify(a)) }
function addNowTs(){
  const now = Date.now();
  let a = loadTs();
  a.push(now);
  const keepAfter = now - 24*60*60*1000;
  if (a.length > 1200) a = a.filter(t => t >= keepAfter);
  saveTs(a);
}
function getLastMinutesCount(min){
  const now = Date.now();
  const after = now - min*60*1000;
  return loadTs().filter(t => t >= after).length;
}
const getLast1HourCount = ()=>getLastMinutesCount(60);
const getLast5MinCount  = ()=>getLastMinutesCount(5);

function applyTopPadding(extra=35){
  const buttonArea = document.getElementById('button-area');
  requestAnimationFrame(()=>{
    const h = buttonArea.getBoundingClientRect().height;
    document.body.style.paddingTop = (h+extra)+'px';
  });
}
window.addEventListener('load', applyTopPadding);
window.addEventListener('resize', ()=>applyTopPadding());

function humanElapsed(iso){
  try{
    const t=new Date(iso).getTime(), s=Math.floor((Date.now()-t)/1000);
    if(s<60) return `${s}ç§’å‰`;
    const m=Math.floor(s/60); if(m<60) return `${m}åˆ†å‰`;
    const h=Math.floor(m/60); if(h<24) return `${h}æ™‚é–“å‰`;
    return `${Math.floor(h/24)}æ—¥å‰`;
  }catch{return""}
}
function pickRandom(pool, excludeEn){
  if (!Array.isArray(pool) || pool.length===0) return null;
  if (pool.length===1) return pool[0];
  let en;
  do { en = pool[Math.floor(Math.random()*pool.length)] } while (en===excludeEn);
  return en;
}

/* localStorage ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚° */
const pendingSaves = new Map(); // key -> stringified value
let saveScheduled = false;
function scheduleSave(key, obj) {
  pendingSaves.set(key, JSON.stringify(obj));
  if (!saveScheduled) {
    saveScheduled = true;
    Promise.resolve().then(() => {
      pendingSaves.forEach((val, k) => localStorage.setItem(k, val));
      pendingSaves.clear();
      saveScheduled = false;
    });
  }
}

/* en â†’ sentence ã®ãƒãƒƒãƒ— */
const byEn = Object.create(null);

/* ========= ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ========= */
fetch(jsonFile)
  .then(r => { if(!r.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${jsonFile}`); return r.json(); })
  .then(data => {
    allSentences = data;
    for (const s of allSentences) byEn[s.en] = s;
    if (remaining.length === 0) remaining = allSentences.map(s=>s.en);
    applyTopPadding();
  })
  .catch(err => {
    document.getElementById("sentence-jp").textContent = "âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    document.getElementById("sentence-en").textContent = err.message;
  });

/* ========= ã‚¹ã‚¿ãƒ¼UIï¼ˆâ˜†å›ºå®šè¡¨ç¤ºï¼‰ ========= */
function updateStarUi(){
  const starBtn = document.getElementById("starBtn");
  if (!currentSentence) {
    starBtn.disabled = true;
  } else {
    starBtn.disabled = false;
  }
  // è¦‹ãŸç›®ã¯å¸¸ã«â˜†å›ºå®š
  starBtn.textContent = "â˜†";
}

/* ========= è¡¨ç¤ºã®å…±é€šå‡¦ç†ï¼ˆâ˜†ãƒãƒƒã‚¸éè¡¨ç¤ºç‰ˆï¼‰ ========= */
function presentSentenceByEn(en){
  const s = byEn[en];
  if (!s) return;
  currentSentence = s;

  // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
  const newShown = (shownCounts[en]||0) + 1;
  shownCounts[en] = newShown;
  scheduleSave(keyPrefix+"shownCounts", shownCounts);
  totalShownCached++;

  todayCounts[en] = (todayCounts[en]||0) + 1;
  scheduleSave(todayCountsKey, todayCounts);
  todayShownCached++;

  addNowTs();

  const prevIso = lastShownMap[en];
  const prevText = prevIso ? humanElapsed(prevIso) : "ãªã—";
  lastShownMap[en] = new Date().toISOString();
  scheduleSave(keyPrefix+"lastShown", lastShownMap);

  const totalShownLastHour = getLast1HourCount();
  const totalShownLast5Min = getLast5MinCount();

  /* â˜†ãƒãƒƒã‚¸ã¯è¡¨ç¤ºã—ãªã„ */
  document.getElementById("sentence-jp").innerHTML =
    `<div class="top-meta">
       ${newShown}å›ç›®<br>${prevText}ï¼ˆ ${totalShownLast5Min} / ${totalShownLastHour} / ${todayShownCached} / ${totalShownCached} ï¼‰
     </div>
     <div>${s.jp}</div>`;
  document.getElementById("sentence-en").textContent = s.en;
  document.getElementById("okBtn").disabled = false;

  updateStarUi();
}

/* ========= é€šå¸¸ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º ========= */
function showRandom(){
  if (remaining.length === 0) {
    document.getElementById("sentence-jp").textContent = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
    return;
  }

  let en;
  if (toggleMode) {
    en = pickRandom(remaining, currentSentence?.en);
  } else {
    let min = Infinity, least = [];
    for (const s of remaining) {
      const c = (shownCounts[s] || 0);
      if (c < min) { min = c; least.length = 0; least.push(s); }
      else if (c === min) { least.push(s); }
    }
    en = pickRandom(least, currentSentence?.en);
  }
  toggleMode = !toggleMode;

  lastShowMode = "all";
  presentSentenceByEn(en);
}

/* ========= â˜†ã®ã¿ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º ========= */
function showRandomStarred(){
  let pool = remaining.filter(en => !!starMarks[en]);
  if (pool.length === 0) {
    pool = Object.keys(starMarks).filter(en => starMarks[en]);
  }
  if (pool.length === 0) {
    alert("â˜†ãŒä»˜ã„ãŸè‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€â˜†ã€ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const en = pickRandom(pool, currentSentence?.en);
  lastShowMode = "star";
  presentSentenceByEn(en);
}

/* ========= OKç¢ºå®š ========= */
function confirmSentence(){
  if (!currentSentence) return;
  yesMarks[currentSentence.en] = true;
  scheduleSave(keyPrefix + "yesMarks", yesMarks);

  remaining = remaining.filter(s => s !== currentSentence.en);
  scheduleSave(keyPrefix + "remaining", remaining);

  if (remaining.length > 0) showRandom();
  else {
    document.getElementById("sentence-jp").textContent = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
  }
}

/* ========= â˜†ãƒˆã‚°ãƒ«ï¼ˆæŠ¼ã—ãŸã‚‰æ¬¡ã¸ï¼è¦‹ãŸç›®ã¯â˜†å›ºå®šï¼‰ ========= */
function toggleStar(){
  if (!currentSentence) return;
  const en = currentSentence.en;
  const now = !starMarks[en];
  starMarks[en] = now;
  scheduleSave(keyPrefix + "starMarks", starMarks);

  updateStarUi();  // ãƒ©ãƒ™ãƒ«ã¯å¸¸ã«ã€Œâ˜†ã€

  if (lastShowMode === "star") showRandomStarred();
  else showRandom();
}

/* ========= ãƒªã‚»ãƒƒãƒˆ ========= */
function clearDailyCounts(){
  const prefix = keyPrefix + "shownCounts_";
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const k = localStorage.key(i);
    if (k && k.startsWith(prefix)) localStorage.removeItem(k);
  }
}
function resetData(){
  if (!confirm("Resetï¼Ÿ")) return;
  localStorage.removeItem(keyPrefix+"shownCounts");
  localStorage.removeItem(keyPrefix+"remaining");
  localStorage.removeItem(keyPrefix+"yesMarks");
  localStorage.removeItem(keyPrefix+"lastShown");
  localStorage.removeItem(keyPrefix+"starMarks");
  localStorage.removeItem(hourTsKey);
  clearDailyCounts();

  shownCounts = {}; yesMarks = {}; lastShownMap = {}; starMarks = {};
  totalShownCached = 0; todayShownCached = 0;
  todayCounts = {}; localStorage.removeItem(todayCountsKey);

  remaining = allSentences.map(s=>s.en); currentSentence = null;
  document.getElementById("sentence-jp").textContent = "Press 'Show Random' to start";
  document.getElementById("sentence-en").textContent = "";
  document.getElementById("last-shown").textContent = "";
  document.getElementById("showBtn").disabled = false;
  document.getElementById("okBtn").disabled = true;
  document.getElementById("starBtn").disabled = true;
  document.getElementById("statsArea").style.display = "none";
  applyTopPadding();
}

/* ========= Stats & Copy ========= */
function showStats(){
  const tbody = document.getElementById("statsBody");
  tbody.innerHTML = "";
  for (const s of allSentences) {
    const c = shownCounts[s.en] || 0;
    const yes = yesMarks[s.en] ? "â—" : "â—‹";
    const star = starMarks[s.en] ? "â˜…" : "â˜†";
    tbody.innerHTML += `
      <tr>
        <td>${s.en}</td>
        <td>${s.jp}</td>
        <td style="text-align:center;">${yes}</td>
        <td style="text-align:center;">${star}</td>
        <td style="text-align:center;">${c}</td>
      </tr>`;
  }
  document.getElementById("statsArea").style.display = "block";
}
function copyStats(){
  const table = document.querySelector("#statsArea table");
  if (!table) { alert("ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  let text = "";
  table.querySelectorAll("tr").forEach(tr => {
    const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
    text += cols.join("@") + "\n";
  });
  navigator.clipboard.writeText(text)
    .then(()=>alert("ä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ ã“ã‚Œã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™ã€‚"))
    .catch(()=>alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById("showBtn").onclick = showRandom;
document.getElementById("showStarBtn").onclick = showRandomStarred;
document.getElementById("okBtn").onclick = () => { if (!currentSentence) return; if (confirm("OKï¼Ÿ")) confirmSentence(); };
document.getElementById("resetBtn").onclick = resetData;
document.getElementById("statsBtn").onclick = showStats;
document.getElementById("copyBtn").onclick = copyStats;
document.getElementById("starBtn").onclick = toggleStar;
</script>
</body>
</html>
