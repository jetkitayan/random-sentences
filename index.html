<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; }

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0; /* ä¸Šä½™ç™½ã¯JSã§è‡ªå‹•èª¿æ•´ */
  background-color: #fafafa;
}

/* ä¸Šã«å›ºå®šã™ã‚‹ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå·¦å³25pxã«çµ±ä¸€ï¼‰ */
#button-area {
  --double-line-color: #000;
  --double-line-thickness: 3px;
  --double-line-gap: 6px;

  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  border-bottom: none;
  padding: 65px 25px 13px 25px;  /* ä¸Š å³ ä¸‹ å·¦ */
  text-align: center;
  z-index: 999;
}

/* 1æ®µç›®ãƒœã‚¿ãƒ³ç¾¤ */
#button-area .row1 {
  display: flex;
  gap: 30px;
  margin-bottom: 17px;
}

#button-area .row1 button {
  flex: 1 1 auto;
  width: 100%;
  margin: 0;
}

/* 2æ®µç›®ï¼ãƒ¯ã‚¤ãƒ‰ã‚’å·¦å³1/2ã§åˆ†å‰²ï¼ˆå³ãŒâ˜† Onlyï¼‰ */
#button-area .row2 {                 /* â˜… å¤‰æ›´ */
  display: flex;
  justify-content: stretch;
  flex-wrap: nowrap;
  gap: 0;                            /* ç¶™ãç›®ãªã— */
  margin: 0;
}
#button-area .row2 button {          /* â˜… å¤‰æ›´ï¼šå·¦å³1/2 */
  flex: 1 1 50%;
  min-width: 0;
}

/* ãƒœã‚¿ãƒ³å…±é€šï¼ˆé«˜ã•ã¯ã“ã“ã§èª¿æ•´ï¼‰ */
button {
  padding: 45px 50px;
  font-size: 40px;
  color: #000;
  margin: 13px 0;
  border-radius: 16px;
  cursor: pointer;
  border: 3px solid #000;
  background: #fff;
  background-color: #d9d9d9;
}

/* ç¶™ãç›®ãŒå¤ªãè¦‹ãˆãªã„ã‚ˆã†ã«å³å´ã ã‘å·¦ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å…±æœ‰é¢¨ã« */
#showStarBtn {                       /* â˜… è¿½åŠ ï¼šå³åŠåˆ†ã®å¢ƒç•Œèª¿æ•´ */
  border-left-width: 1px;            /* çœŸã‚“ä¸­ã®ç·šãŒå¤ªããªã‚Šã™ããªã„ã‚ˆã†ã« */
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
#showBtn {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

#content {
  margin-top: -15px;
  padding-left: 40px;
  max-width: 900px;
}

/* â€”â€” 3è¡Œã®ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’çµ±ä¸€ â€”â€” */
#sentence-jp,
#sentence-en,
#last-shown {
  margin: 40px 0;
}

/* æ–‡å­—ã‚µã‚¤ã‚ºãªã©ã¯å¾“æ¥é€šã‚Šï¼ˆjp/enã®ã¿å…±é€šæŒ‡å®šï¼‰ */
.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

/* 1è¡Œç›®å†…ã®è£œè¶³ãƒ¡ã‚¿ã®ä¸‹ä½™ç™½ã§1è¡Œç›®ã¨2è¡Œç›®ã®é–“éš”ã‚’ä½œã‚‹ */
.top-meta {
  margin: 0;
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 40px;
}

#statsArea table {
  border-collapse: collapse;
  width: 100%;
}

#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* ã‚·ãƒ³ã‚°ãƒ«æ™‚ä»£ã®ä½™å‰°æŒ‡å®šã¯æ®‹ã—ã¦OKï¼ˆé«˜ã•ã ã‘ä½¿ã‚ã‚Œã‚‹ï¼‰ */
#showBtn { padding: 80px; }
</style>
</head>
<body>

<!-- å¸¸ã«ä¸Šå›ºå®šã®ãƒœã‚¿ãƒ³ç¾¤ -->
<div id="button-area">
  <!-- 1æ®µç›®ï¼š5ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ï¼ˆâ˜†è¿½åŠ ï¼‰ -->
  <div class="row1">
    <button id="okBtn" disabled>OK</button>
    <button id="starBtn" disabled>â˜† Star</button>
    <button id="resetBtn">Reset</button>
    <button id="statsBtn">Stats</button>
    <button id="copyBtn">Mail</button>
  </div>
  <!-- 2æ®µç›®ï¼šæ¨ªå¹…ã„ã£ã±ã„ã® Show Random ã‚’å·¦å³1/2ã«åˆ†å‰² -->
  <div class="row2">
    <button id="showBtn">Show Random</button>
    <button id="showStarBtn">â˜† Only</button> <!-- â˜… è¿½åŠ ï¼šå³åŠåˆ† -->
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<!-- è¡¨ç¤ºå±¥æ­´ä¸€è¦§ -->
<div id="statsArea">
  <h3>ğŸ“Š è¡¨ç¤ºå±¥æ­´ä¸€è¦§</h3>
  <table>
    <thead>
      <tr>
        <th>æ—¥æœ¬èª</th>
        <th>è‹±èª</th>
        <th>YESæŠ¼ä¸‹</th>
        <th>â˜†</th>
        <th>è¡¨ç¤ºå›æ•°</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
  // ====== åˆæœŸåŒ– ======
  let allSentences = [];
  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get("file") || "default";
  const jsonFile = `${fileParam}.json`;

  const keyPrefix = `randomApp_${fileParam}_`;

  let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
  let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
  let starMarks   = JSON.parse(localStorage.getItem(keyPrefix + "starMarks")) || {}; // â˜†çŠ¶æ…‹
  let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
  let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

  // --- ä»Šæ—¥(Asia/Tokyo) ã®æ—¥ä»˜ã‚­ãƒ¼ã¨å½“æ—¥ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç·æ•°ç®—å‡ºç”¨ï¼‰ ---
  function getTodayYMD() {
    const now = new Date();
    const tz = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
    const y = tz.getFullYear();
    const m = String(tz.getMonth() + 1).padStart(2, '0');
    const d = String(tz.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  const todayKey = getTodayYMD();
  const todayCountsKey = keyPrefix + "shownCounts_" + todayKey;
  let todayCounts = JSON.parse(localStorage.getItem(todayCountsKey)) || {};

  const sumCounts = (obj) => Object.values(obj).reduce((a,b)=>a + (b||0), 0);

  let currentSentence = null;
  let toggleMode = true; // true: ãƒ©ãƒ³ãƒ€ãƒ  / false: æœ€å°‘å›æ•°

  // ====== ç›´è¿‘1æ™‚é–“é›†è¨ˆç”¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é…åˆ— ======
  const hourTsKey = keyPrefix + "shownTimestamps";
  function loadTs() {
    try { const arr = JSON.parse(localStorage.getItem(hourTsKey)); return Array.isArray(arr) ? arr : []; }
    catch { return []; }
  }
  function saveTs(arr) { localStorage.setItem(hourTsKey, JSON.stringify(arr)); }
  function addNowTs() {
    const now = Date.now();
    let arr = loadTs();
    arr.push(now);
    const keepAfter = now - 24 * 60 * 60 * 1000;
    arr = arr.filter(t => typeof t === "number" && t >= keepAfter);
    saveTs(arr);
  }

  // ====== ç›´è¿‘1æ™‚é–“/5åˆ† é›†è¨ˆ ======
  function getLastMinutesCount(min) {
    const now = Date.now();
    const after = now - min * 60 * 1000;
    return loadTs().filter(t => t >= after).length;
  }
  function getLast1HourCount() { return getLastMinutesCount(60); }
  function getLast5MinCount() { return getLastMinutesCount(5); }

  // ====== ä¸Šå›ºå®šã®ãŸã‚ã®è‡ªå‹•ä½™ç™½èª¿æ•´ ======
  function applyTopPadding(extra = 35) {
    const buttonArea = document.getElementById('button-area');
    requestAnimationFrame(() => {
      const h = buttonArea.getBoundingClientRect().height;
      document.body.style.paddingTop = (h + extra) + 'px';
    });
  }
  window.addEventListener('load', applyTopPadding);
  window.addEventListener('resize', () => applyTopPadding());

  // ====== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
  fetch(jsonFile)
    .then(r => { if (!r.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${jsonFile}`); return r.json(); })
    .then(data => {
      allSentences = data;
      if (remaining.length === 0) remaining = allSentences.map(s => s.en);
      applyTopPadding();
    })
    .catch(err => {
      document.getElementById("sentence-jp").innerText = "âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      document.getElementById("sentence-en").innerText = err.message;
    });

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function humanElapsed(iso){
    try{
      const t=new Date(iso).getTime(),s=Math.floor((Date.now()-t)/1000);
      if(s<60)return`${s}ç§’å‰`;
      const m=Math.floor(s/60); if(m<60)return`${m}åˆ†å‰`;
      const h=Math.floor(m/60); if(h<24)return`${h}æ™‚é–“å‰`;
      const d=Math.floor(h/24); return`${d}æ—¥å‰`;
    }catch{return"";}
  }

  // ====== ã‚¹ã‚¿ãƒ¼UIåæ˜  ======
  function updateStarUi() {
    const starBtn = document.getElementById("starBtn");
    if (!currentSentence) {
      starBtn.disabled = true;
      starBtn.textContent = "â˜† Star";
      return;
    }
    const en = currentSentence.en;
    const starred = !!starMarks[en];
    starBtn.disabled = false;
    starBtn.textContent = starred ? "â˜… Unstar" : "â˜† Star";
  }

  // ====== å…±é€šï¼šå®Ÿéš›ã«è¡¨ç¤ºã™ã‚‹å‡¦ç† ======
  function presentSentenceByEn(en) {                              // â˜… è¿½åŠ ï¼šå…±é€šåŒ–
    const lastShownDiv = document.getElementById("last-shown");
    currentSentence = allSentences.find(s => s.en === en);
    if (!currentSentence) return;

    // ---- ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–° ----
    shownCounts[en] = (shownCounts[en] || 0) + 1;
    localStorage.setItem(keyPrefix + "shownCounts", JSON.stringify(shownCounts));
    todayCounts[en] = (todayCounts[en] || 0) + 1;
    localStorage.setItem(todayCountsKey, JSON.stringify(todayCounts));
    addNowTs();

    const totalShown = Object.values(shownCounts).reduce((a,b)=>a+b,0);
    const totalShownToday = sumCounts(todayCounts);
    const totalShownLastHour = getLast1HourCount();
    const totalShownLast5Min = getLast5MinCount();

    const prevIso = lastShownMap[en];
    const prevText = prevIso ? humanElapsed(prevIso) : "ãªã—";

    const starred = !!starMarks[en];
    const starBadge = starred ? "â˜…" : "â˜†";

    document.getElementById("sentence-jp").innerHTML = `
      <div class="top-meta">
        ${starBadge}ã€€${shownCounts[en]}å›ç›®<br>${prevText}ï¼ˆ ${totalShownLast5Min} / ${totalShownLastHour} / ${totalShownToday} / ${totalShown} ï¼‰
      </div>
      <div>${currentSentence.jp}</div>`;
    document.getElementById("sentence-en").innerText = currentSentence.en;

    document.getElementById("okBtn").disabled = false;
    lastShownMap[en] = new Date().toISOString();
    localStorage.setItem(keyPrefix + "lastShown", JSON.stringify(lastShownMap));
    updateStarUi();
  }

  // ====== å¾“æ¥ï¼šå…¨ä½“ã‹ã‚‰è¡¨ç¤º ======
  function showRandom() {
    const lastShownDiv = document.getElementById("last-shown");
    if (remaining.length === 0) {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      lastShownDiv.textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
      document.getElementById("starBtn").disabled = true;
      return;
    }

    let en;
    if (toggleMode) {
      en = remaining[Math.floor(Math.random() * remaining.length)];
    } else {
      let min = Infinity, least = [];
      remaining.forEach(s => {
        const c = shownCounts[s] || 0;
        if (c < min) { min = c; least = [s]; }
        else if (c === min) { least.push(s); }
      });
      en = least[Math.floor(Math.random() * least.length)];
    }
    toggleMode = !toggleMode;

    presentSentenceByEn(en);
  }

  // ====== â˜… æ–°è¦ï¼šâ˜†ã®ã¿ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º ======
  function showRandomStarred() {
    // å„ªå…ˆï¼šremaining âˆ© starred
    const starredRemaining = remaining.filter(en => !!starMarks[en]);
    let pool = starredRemaining;
    if (pool.length === 0) {
      // ä»£æ›¿ï¼šå…¨â˜†ï¼ˆOKæ¸ˆã¿ã§ã‚‚å­¦ã³ç›´ã—ã—ãŸã„ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œï¼‰
      pool = Object.keys(starMarks).filter(en => starMarks[en]);
    }
    if (pool.length === 0) {
      alert("â˜†ãŒä»˜ã„ãŸè‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€â˜† Starã€ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    const en = pool[Math.floor(Math.random() * pool.length)];
    presentSentenceByEn(en);
  }

  function confirmSentence() {
    if (!currentSentence) return;
    yesMarks[currentSentence.en] = true;
    localStorage.setItem(keyPrefix + "yesMarks", JSON.stringify(yesMarks));
    remaining = remaining.filter(s => s !== currentSentence.en);
    localStorage.setItem(keyPrefix + "remaining", JSON.stringify(remaining));
    if (remaining.length > 0) showRandom();
    else {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      document.getElementById("last-shown").textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
      document.getElementById("starBtn").disabled = true;
    }
  }

  // â˜†ã®ãƒˆã‚°ãƒ«
  function toggleStar() {
    if (!currentSentence) return;
    const en = currentSentence.en;
    const now = !starMarks[en];
    starMarks[en] = now;
    localStorage.setItem(keyPrefix + "starMarks", JSON.stringify(starMarks));
    updateStarUi();
    // ä¸Šéƒ¨ãƒãƒƒã‚¸ã‚‚å·®ã—æ›¿ãˆ
    const jpDiv = document.getElementById("sentence-jp");
    jpDiv.innerHTML = jpDiv.innerHTML.replace(/(<div class="top-meta">\s*)([â˜…â˜†])/, (_, a) => a + (now ? "â˜…" : "â˜†"));
  }

  // å½“æ—¥ã‚«ã‚¦ãƒ³ãƒˆå…¨å‰Šé™¤
  function clearDailyCounts() {
    const prefix = keyPrefix + "shownCounts_";
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const k = localStorage.key(i);
      if (k && k.startsWith(prefix)) localStorage.removeItem(k);
    }
  }

  function resetData() {
    if (!confirm("Resetï¼Ÿ")) return;
    localStorage.removeItem(keyPrefix + "shownCounts");
    localStorage.removeItem(keyPrefix + "remaining");
    localStorage.removeItem(keyPrefix + "yesMarks");
    localStorage.removeItem(keyPrefix + "lastShown");
    localStorage.removeItem(keyPrefix + "starMarks");
    clearDailyCounts();
    localStorage.removeItem(hourTsKey);

    shownCounts = {}; yesMarks = {}; lastShownMap = {}; starMarks = {};
    todayCounts = {}; localStorage.removeItem(todayCountsKey);

    remaining = allSentences.map(s => s.en); currentSentence = null;
    document.getElementById("sentence-jp").innerText = "Press 'Show Random' to start";
    document.getElementById("sentence-en").innerText = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = false;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
    document.getElementById("statsArea").style.display = "none";
    applyTopPadding();
  }

  function showStats() {
    const tbody = document.getElementById("statsBody");
    tbody.innerHTML = "";
    allSentences.forEach(s => {
      const c = shownCounts[s.en] || 0;
      const yes = yesMarks[s.en] ? "â—" : "â—‹";
      const star = starMarks[s.en] ? "â˜…" : "â˜†";
      tbody.innerHTML += `
        <tr>
          <td>${s.en}</td>
          <td>${s.jp}</td>
          <td style="text-align:center;">${yes}</td>
          <td style="text-align:center;">${star}</td>
          <td style="text-align:center;">${c}</td>
        </tr>`;
    });
    document.getElementById("statsArea").style.display = "block";
  }

  function copyStats() {
    const table = document.querySelector("#statsArea table");
    if (!table) { alert("ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
    let text = "";
    table.querySelectorAll("tr").forEach(tr => {
      const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
      text += cols.join("@") + "\n";
    });
    navigator.clipboard.writeText(text)
      .then(() => {
        alert("ä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ ã“ã‚Œã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™ã€‚");
        const to = "jetkitayan@gmail.com";
        const subject = "Random English Sentences - Stats";
        const body = "";
        const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoUrl, "_blank");
      })
      .catch(() => alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  document.getElementById("showBtn").onclick = showRandom;
  document.getElementById("showStarBtn").onclick = showRandomStarred; // â˜… è¿½åŠ ï¼šå³åŠåˆ†
  document.getElementById("okBtn").onclick = () => { if (!currentSentence) return; if (confirm("OKï¼Ÿ")) { confirmSentence(); } };
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("statsBtn").onclick = showStats;
  document.getElementById("copyBtn").onclick = copyStats;
  document.getElementById("starBtn").onclick = toggleStar;
</script>
</body>
</html>
