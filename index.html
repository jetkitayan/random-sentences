<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Random English Sentences</title>
<style>
* , *::before, *::after { box-sizing: border-box; }

body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background-color: #fafafa;
}

/* ä¸Šã«å›ºå®šã™ã‚‹ãƒœã‚¿ãƒ³ç¾¤ */
#button-area {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 65px 25px 13px 25px;
  text-align: center;
  z-index: 999;
}

/* === 1æ®µç›® === */
#button-area .row1 {
  display: flex;
  justify-content: center;   /* ä¸­å¤®å¯„ã› */
  flex-wrap: nowrap;
  gap: 25px;
  margin-bottom: 17px;
  max-width: 900px;          /* 2æ®µç›®ã¨åŒã˜å¹…ã«åˆ¶é™ */
  margin-left: auto;
  margin-right: auto;
}

#button-area .row1 button {
  flex: 1 1 0;
  min-width: 140px;
  max-width: 170px;          /* å¹…ãŒåºƒãŒã‚Šã™ããªã„ */
}

/* === 2æ®µç›® === */
#button-area .row2 {
  display: flex;
  justify-content: center;
  flex-wrap: nowrap;
  margin: 0 auto;
  max-width: 900px;          /* 1æ®µç›®ã¨åŒå¹… */
}
#button-area .row2 button {
  flex: 1 1 50%;
  min-width: 0;
}

/* å…±é€šãƒœã‚¿ãƒ³ */
button {
  padding: 45px 50px;
  font-size: 40px;
  color: #000;
  border-radius: 16px;
  border: 3px solid #000;
  background-color: #d9d9d9;
  cursor: pointer;
}

/* 2æ®µç›®ã®ç¶™ãç›®ã‚’è‡ªç„¶ã« */
#showStarBtn {
  border-left-width: 1px;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
#showBtn {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

#content {
  margin-top: -15px;
  padding-left: 40px;
  max-width: 900px;
}

#sentence-jp, #sentence-en, #last-shown {
  margin: 40px 0;
}

.count-label,
#sentence-jp,
#sentence-en {
  line-height: 1.6;
  font-size: 43px;
  color: #000;
}

.top-meta {
  margin: 0;
  padding-bottom: 46px;
}

#statsArea {
  display: none;
  padding: 20px 40px;
}
#statsArea table {
  border-collapse: collapse;
  width: 100%;
}
#statsArea th, #statsArea td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
</style>
</head>
<body>

<div id="button-area">
  <div class="row1">
    <button id="okBtn" disabled>OK</button>
    <button id="starBtn" disabled>â˜† Star</button>
    <button id="resetBtn">Reset</button>
    <button id="statsBtn">Stats</button>
    <button id="copyBtn">Mail</button>
  </div>

  <div class="row2">
    <button id="showBtn">Show Random</button>
    <button id="showStarBtn">â˜† Only</button>
  </div>
</div>

<div id="content">
  <div id="sentence-jp">Press "Show Random" to start</div>
  <div id="sentence-en"></div>
  <div id="last-shown"></div>
</div>

<div id="statsArea">
  <h3>ğŸ“Š è¡¨ç¤ºå±¥æ­´ä¸€è¦§</h3>
  <table>
    <thead>
      <tr>
        <th>æ—¥æœ¬èª</th><th>è‹±èª</th><th>YESæŠ¼ä¸‹</th><th>â˜†</th><th>è¡¨ç¤ºå›æ•°</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<script>
/* ========= å¤‰æ•°ãƒ»çŠ¶æ…‹ ========= */
let allSentences = [];
const params = new URLSearchParams(window.location.search);
const fileParam = params.get("file") || "default";
const jsonFile = `${fileParam}.json`;
const keyPrefix = `randomApp_${fileParam}_`;

/* æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆãªã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ */
let shownCounts = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
let yesMarks    = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
let starMarks   = JSON.parse(localStorage.getItem(keyPrefix + "starMarks")) || {};
let remaining   = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
let lastShownMap= JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

/* ç›´å‰ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼š"all" | "star"ï¼ˆâ˜†ãƒˆã‚°ãƒ«å¾Œã®è‡ªå‹•é·ç§»ç”¨ï¼‰ */
let lastShowMode = "all";

/* ä»Šæ—¥ã‚«ã‚¦ãƒ³ãƒˆ */
function getTodayYMD() {
  const now = new Date();
  const tz = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  const y = tz.getFullYear();
  const m = String(tz.getMonth() + 1).padStart(2, '0');
  const d = String(tz.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
const todayKey = getTodayYMD();
const todayCountsKey = keyPrefix + "shownCounts_" + todayKey;
let todayCounts = JSON.parse(localStorage.getItem(todayCountsKey)) || {};

/* ---- â‘¡ é›†è¨ˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆåˆæœŸåŒ–ã¯ä¸€åº¦ã ã‘reduceï¼‰ ---- */
let totalShownCached = Object.values(shownCounts).reduce((a,b)=>a+(b||0),0);
let todayShownCached = Object.values(todayCounts).reduce((a,b)=>a+(b||0),0);

/* ç›´è¿‘ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— */
const hourTsKey = keyPrefix + "shownTimestamps";

/* ç”»é¢çŠ¶æ…‹ */
let currentSentence = null;
let toggleMode = true; // true: ãƒ©ãƒ³ãƒ€ãƒ  / false: æœ€å°‘å›æ•°

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function loadTs(){ try{ const a=JSON.parse(localStorage.getItem(hourTsKey)); return Array.isArray(a)?a:[] } catch { return [] } }
function saveTs(a){ localStorage.setItem(hourTsKey, JSON.stringify(a)) }
function addNowTs(){
  const now = Date.now();
  let a = loadTs();
  a.push(now);
  const keepAfter = now - 24*60*60*1000;
  // å¤ã„ã®ã‚’é–“å¼•ã
  if (a.length > 1200) a = a.filter(t => t >= keepAfter);
  saveTs(a);
}
function getLastMinutesCount(min){
  const now = Date.now();
  const after = now - min*60*1000;
  return loadTs().filter(t => t >= after).length;
}
const getLast1HourCount = ()=>getLastMinutesCount(60);
const getLast5MinCount  = ()=>getLastMinutesCount(5);

function applyTopPadding(extra=35){
  const buttonArea = document.getElementById('button-area');
  requestAnimationFrame(()=>{
    const h = buttonArea.getBoundingClientRect().height;
    document.body.style.paddingTop = (h+extra)+'px';
  });
}
window.addEventListener('load', applyTopPadding);
window.addEventListener('resize', ()=>applyTopPadding());

function humanElapsed(iso){
  try{
    const t=new Date(iso).getTime(), s=Math.floor((Date.now()-t)/1000);
    if(s<60) return `${s}ç§’å‰`;
    const m=Math.floor(s/60); if(m<60) return `${m}åˆ†å‰`;
    const h=Math.floor(m/60); if(h<24) return `${h}æ™‚é–“å‰`;
    return `${Math.floor(h/24)}æ—¥å‰`;
  }catch{return""}
}
function pickRandom(pool, excludeEn){
  if (!Array.isArray(pool) || pool.length===0) return null;
  if (pool.length===1) return pool[0];
  let en;
  do { en = pool[Math.floor(Math.random()*pool.length)] } while (en===excludeEn);
  return en;
}

/* ---- â‘¢ localStorageã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ï¼šåŒä¸€ãƒ†ã‚£ãƒƒã‚¯ã§ã¾ã¨ã‚æ›¸ã ---- */
const pendingSaves = new Map(); // key -> stringified value
let saveScheduled = false;
function scheduleSave(key, obj) {
  pendingSaves.set(key, JSON.stringify(obj));
  if (!saveScheduled) {
    saveScheduled = true;
    Promise.resolve().then(() => {
      pendingSaves.forEach((val, k) => localStorage.setItem(k, val));
      pendingSaves.clear();
      saveScheduled = false;
    });
  }
}

/* ========= â‘  ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼ˆen â†’ sentenceï¼‰ ========= */
const byEn = Object.create(null);

/* ========= ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ========= */
fetch(jsonFile)
  .then(r => { if(!r.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${jsonFile}`); return r.json(); })
  .then(data => {
    allSentences = data;
    for (const s of allSentences) byEn[s.en] = s;           // â˜… ãƒãƒƒãƒ—ä½œæˆ
    if (remaining.length === 0) remaining = allSentences.map(s=>s.en);
    applyTopPadding();
  })
  .catch(err => {
    document.getElementById("sentence-jp").textContent = "âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    document.getElementById("sentence-en").textContent = err.message;
  });

/* ========= ã‚¹ã‚¿ãƒ¼UI ========= */
function updateStarUi(){
  const starBtn = document.getElementById("starBtn");
  if (!currentSentence) {
    starBtn.disabled = true;
    starBtn.textContent = "â˜† Star";
    return;
  }
  const en = currentSentence.en;
  const starred = !!starMarks[en];
  starBtn.disabled = false;
  starBtn.textContent = starred ? "â˜… Unstar" : "â˜† Star";
}

/* ========= è¡¨ç¤ºã®å…±é€šå‡¦ç†ï¼ˆé«˜é€ŸåŒ–ç‰ˆï¼‰ ========= */
function presentSentenceByEn(en){
  const s = byEn[en];                 // â˜… O(1) å‚ç…§
  if (!s) return;
  currentSentence = s;

  // ---- ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¢—åˆ†æ›´æ–°ï¼‰ ----
  const newShown = (shownCounts[en]||0) + 1;
  shownCounts[en] = newShown;
  scheduleSave(keyPrefix+"shownCounts", shownCounts);
  totalShownCached++;                 // â˜… reduceä¸è¦

  todayCounts[en] = (todayCounts[en]||0) + 1;
  scheduleSave(todayCountsKey, todayCounts);
  todayShownCached++;                 // â˜… reduceä¸è¦

  addNowTs();

  const prevIso = lastShownMap[en];
  const prevText = prevIso ? humanElapsed(prevIso) : "ãªã—";
  lastShownMap[en] = new Date().toISOString();
  scheduleSave(keyPrefix+"lastShown", lastShownMap);

  const totalShownLastHour = getLast1HourCount();
  const totalShownLast5Min = getLast5MinCount();
  const starBadge = starMarks[en] ? "â˜…" : "â˜†";

  // ã¾ã¨ã‚ã¦æœ€å°é™æ›´æ–°
  document.getElementById("sentence-jp").innerHTML =
    `<div class="top-meta">
       ${starBadge}ã€€${newShown}å›ç›®<br>${prevText}ï¼ˆ ${totalShownLast5Min} / ${totalShownLastHour} / ${todayShownCached} / ${totalShownCached} ï¼‰
     </div>
     <div>${s.jp}</div>`;
  document.getElementById("sentence-en").textContent = s.en;
  document.getElementById("okBtn").disabled = false;

  updateStarUi();
}

/* ========= é€šå¸¸ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º ========= */
function showRandom(){
  if (remaining.length === 0) {
    document.getElementById("sentence-jp").textContent = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
    return;
  }

  let en;
  if (toggleMode) {
    en = pickRandom(remaining, currentSentence?.en);
  } else {
    // â˜… â‘£ 1ãƒ‘ã‚¹ã§æœ€å°ã‚«ã‚¦ãƒ³ãƒˆï¼†å€™è£œåé›†
    let min = Infinity;
    let least = [];
    for (const s of remaining) {
      const c = shownCounts[s] || 0;
      if (c < min) { min = c; least.length = 0; least.push(s); }
      else if (c === min) { least.push(s); }
    }
    en = pickRandom(least, currentSentence?.en);
  }
  toggleMode = !toggleMode;

  lastShowMode = "all";
  presentSentenceByEn(en);
}

/* ========= â˜†ã®ã¿ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º ========= */
function showRandomStarred(){
  let pool = remaining.filter(en => !!starMarks[en]);
  if (pool.length === 0) {
    pool = Object.keys(starMarks).filter(en => starMarks[en]);
  }
  if (pool.length === 0) {
    alert("â˜†ãŒä»˜ã„ãŸè‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€â˜† Starã€ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const en = pickRandom(pool, currentSentence?.en);
  lastShowMode = "star";
  presentSentenceByEn(en);
}

/* ========= OKç¢ºå®š ========= */
function confirmSentence(){
  if (!currentSentence) return;
  yesMarks[currentSentence.en] = true;
  scheduleSave(keyPrefix + "yesMarks", yesMarks);

  remaining = remaining.filter(s => s !== currentSentence.en);
  scheduleSave(keyPrefix + "remaining", remaining);

  if (remaining.length > 0) showRandom();
  else {
    document.getElementById("sentence-jp").textContent = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = true;
    document.getElementById("okBtn").disabled = true;
    document.getElementById("starBtn").disabled = true;
  }
}

/* ========= â˜†ãƒˆã‚°ãƒ«ï¼ˆå¾Œç¶šè‡ªå‹•é·ç§»ï¼‰ ========= */
function toggleStar(){
  if (!currentSentence) return;
  const en = currentSentence.en;
  const now = !starMarks[en];
  starMarks[en] = now;
  scheduleSave(keyPrefix + "starMarks", starMarks);
  updateStarUi();

  if (lastShowMode === "star") showRandomStarred();
  else showRandom();
}

/* ========= ãƒªã‚»ãƒƒãƒˆ ========= */
function clearDailyCounts(){
  const prefix = keyPrefix + "shownCounts_";
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const k = localStorage.key(i);
    if (k && k.startsWith(prefix)) localStorage.removeItem(k);
  }
}
function resetData(){
  if (!confirm("Resetï¼Ÿ")) return;
  localStorage.removeItem(keyPrefix+"shownCounts");
  localStorage.removeItem(keyPrefix+"remaining");
  localStorage.removeItem(keyPrefix+"yesMarks");
  localStorage.removeItem(keyPrefix+"lastShown");
  localStorage.removeItem(keyPrefix+"starMarks");
  localStorage.removeItem(hourTsKey);
  clearDailyCounts();

  shownCounts = {}; yesMarks = {}; lastShownMap = {}; starMarks = {};
  totalShownCached = 0; todayShownCached = 0;
  todayCounts = {}; localStorage.removeItem(todayCountsKey);

  remaining = allSentences.map(s=>s.en); currentSentence = null;
  document.getElementById("sentence-jp").textContent = "Press 'Show Random' to start";
  document.getElementById("sentence-en").textContent = "";
  document.getElementById("last-shown").textContent = "";
  document.getElementById("showBtn").disabled = false;
  document.getElementById("okBtn").disabled = true;
  document.getElementById("starBtn").disabled = true;
  document.getElementById("statsArea").style.display = "none";
  applyTopPadding();
}

/* ========= Stats & Copy ========= */
function showStats(){
  const tbody = document.getElementById("statsBody");
  tbody.innerHTML = "";
  for (const s of allSentences) {
    const c = shownCounts[s.en] || 0;
    const yes = yesMarks[s.en] ? "â—" : "â—‹";
    const star = starMarks[s.en] ? "â˜…" : "â˜†";
    tbody.innerHTML += `
      <tr>
        <td>${s.en}</td>
        <td>${s.jp}</td>
        <td style="text-align:center;">${yes}</td>
        <td style="text-align:center;">${star}</td>
        <td style="text-align:center;">${c}</td>
      </tr>`;
  }
  document.getElementById("statsArea").style.display = "block";
}
function copyStats(){
  const table = document.querySelector("#statsArea table");
  if (!table) { alert("ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  let text = "";
  table.querySelectorAll("tr").forEach(tr => {
    const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
    text += cols.join("@") + "\n";
  });
  navigator.clipboard.writeText(text)
    .then(()=>alert("ä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ ã“ã‚Œã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™ã€‚"))
    .catch(()=>alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById("showBtn").onclick = showRandom;
document.getElementById("showStarBtn").onclick = showRandomStarred;
document.getElementById("okBtn").onclick = () => { if (!currentSentence) return; if (confirm("OKï¼Ÿ")) confirmSentence(); };
document.getElementById("resetBtn").onclick = resetData;
document.getElementById("statsBtn").onclick = showStats;
document.getElementById("copyBtn").onclick = copyStats;
document.getElementById("starBtn").onclick = toggleStar;
</script>
</body>
</html>

