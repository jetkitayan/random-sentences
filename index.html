<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Random English Sentences</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0 0 160px 0; /* ä¸‹é…ç½®æ™‚ã®ä½™ç™½ */
      background-color: #fafafa;
    }

    /* è¿½åŠ ï¼šãƒœã‚¿ãƒ³ä¸Šé…ç½®ç”¨ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆé€šå¸¸ã¯é«˜ã•0ï¼‰ */
    #button-spacer { height: 0; }

    #content {
      margin-top: 20px;
      padding-left: 40px;
      max-width: 900px;
    }

    .count-label,
    #sentence-jp,
    #sentence-en {
      margin: 50px 0;
      line-height: 1.6;
      font-size: 48px;
      color: #000;
    }

    /* å‰å›è¡¨ç¤ºæ—¥æ™‚ */
    #last-shown {
      margin-top: 16px;
      font-size: 48px;
      color: #555;
    }

    #button-area {
      position: fixed;
      bottom: 30px;
      left: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 60px 13px;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      z-index: 999; /* é‡ãªã‚Šé † */
    }

    /* å„æ®µã®ãƒœã‚¿ãƒ³ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ */
    .button-row {
      display: flex;
      justify-content: center;
      gap: 25px;
    }

    button {
      padding: 60px 60px;
      font-size: 32px;
      margin: 25px 5px;
      border-radius: 16px;
      cursor: pointer;
    }

    #statsArea {
      display: none;
      padding: 20px 40px;
    }

    #statsArea table {
      border-collapse: collapse;
      width: 100%;
    }

    #statsArea th,
    #statsArea td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    /* è¡¨ç¤ºå›æ•°ãªã©ã®ä¸Šéƒ¨ãƒ¡ã‚¿æƒ…å ± */
    .top-meta {
      margin-bottom: 50px;
    }

    /* â¬†/â¬‡ ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    #moveToggleBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      font-size: 20px;
      padding: 10px 20px;
      border-radius: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- è¿½åŠ ï¼šä¸Šé…ç½®æ™‚ã ã‘é«˜ã•ã‚’æŒãŸã›ã‚‹ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->
  <div id="button-spacer"></div>

  <div id="content">
    <div id="sentence-jp">Press "Show Random" to start</div>
    <div id="sentence-en"></div>
    <!-- å‰å›è¡¨ç¤ºæ—¥æ™‚ -->
    <div id="last-shown"></div>
  </div>

  <div id="button-area">
    <div class="button-row">
      <button id="showBtn">Show Random</button>
      <button id="okBtn" disabled>OK (YES)</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div class="button-row">
      <button id="statsBtn">Show Stats</button>
      <button id="copyBtn">Copy Stats</button>
    </div>
  </div>

  <!-- è¡¨ç¤ºå±¥æ­´ä¸€è¦§ -->
  <div id="statsArea">
    <h3>ğŸ“Š è¡¨ç¤ºå±¥æ­´ä¸€è¦§</h3>
    <table>
      <thead>
        <tr>
          <th>æ—¥æœ¬èª</th>
          <th>è‹±èª</th>
          <th>YESæŠ¼ä¸‹</th>
          <th>è¡¨ç¤ºå›æ•°</th>
        </tr>
      </thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <!-- ãƒœã‚¿ãƒ³ç¾¤ã®ä¸Šä¸‹åˆ‡æ›¿ -->
  <button id="moveToggleBtn">â¬† Move Buttons Up</button>

  <script>
  // ====== åˆæœŸåŒ– ======
  let allSentences = [];
  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get("file") || "default";
  const jsonFile = `${fileParam}.json`;

  // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®ã‚­ãƒ¼ã‚’ä½œæˆ
  const keyPrefix = `randomApp_${fileParam}_`;

  let shownCounts   = JSON.parse(localStorage.getItem(keyPrefix + "shownCounts")) || {};
  let yesMarks      = JSON.parse(localStorage.getItem(keyPrefix + "yesMarks")) || {};
  let remaining     = JSON.parse(localStorage.getItem(keyPrefix + "remaining")) || [];
  // å‰å›è¡¨ç¤ºæ™‚åˆ»ï¼ˆISOæ–‡å­—åˆ—ï¼‰ã‚’è‹±æ–‡æ˜æ–‡ã‚­ãƒ¼ã§ä¿æŒ
  let lastShownMap  = JSON.parse(localStorage.getItem(keyPrefix + "lastShown")) || {};

  let currentSentence = null;
  let toggleMode = true; // true: ãƒ©ãƒ³ãƒ€ãƒ  / false: æœ€å°‘å›æ•°

  console.log("ğŸ“„ èª­ã¿è¾¼ã‚€JSONãƒ•ã‚¡ã‚¤ãƒ«:", jsonFile);

  // JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  fetch(jsonFile)
    .then(response => {
      if (!response.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${jsonFile}`);
      return response.json();
    })
    .then(data => {
      allSentences = data;
      if (remaining.length === 0) remaining = allSentences.map(s => s.en);
    })
    .catch(err => {
      document.getElementById("sentence-jp").innerText = "âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      document.getElementById("sentence-en").innerText = err.message;
    });

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function formatJp(dtIso) {
    try {
      const d = new Date(dtIso);
      return d.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
    } catch {
      return dtIso || "";
    }
  }

  function humanElapsed(fromIso) {
    try {
      const from = new Date(fromIso).getTime();
      const now = Date.now();
      const diffSec = Math.floor((now - from) / 1000);
      if (diffSec < 60) return `${diffSec}ç§’å‰`;
      const diffMin = Math.floor(diffSec / 60);
      if (diffMin < 60) return `${diffMin}åˆ†å‰`;
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return `${diffHr}æ™‚é–“å‰`;
      const diffDay = Math.floor(diffHr / 24);
      return `${diffDay}æ—¥å‰`;
    } catch {
      return "";
    }
  }

  // ====== é–¢æ•°å®šç¾© ======

  // âœ… ãƒ©ãƒ³ãƒ€ãƒ ï¼æœ€å°‘å›æ•°è¡¨ç¤ºã‚’äº¤äº’ã«å®Ÿè¡Œ
  function showRandom() {
    const lastShownDiv = document.getElementById("last-shown");

    if (remaining.length === 0) {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      lastShownDiv.textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
      return;
    }

    let en;
    if (toggleMode) {
      en = remaining[Math.floor(Math.random() * remaining.length)];
    } else {
      let minCount = Infinity;
      let leastShownList = [];
      remaining.forEach(s => {
        const count = shownCounts[s] || 0;
        if (count < minCount) {
          minCount = count;
          leastShownList = [s];
        } else if (count === minCount) {
          leastShownList.push(s);
        }
      });
      en = leastShownList[Math.floor(Math.random() * leastShownList.length)];
    }
    toggleMode = !toggleMode;

    currentSentence = allSentences.find(s => s.en === en);

    shownCounts[en] = (shownCounts[en] || 0) + 1;
    localStorage.setItem(keyPrefix + "shownCounts", JSON.stringify(shownCounts));

    const totalShown = Object.values(shownCounts).reduce((a, b) => a + b, 0);

    document.getElementById("sentence-jp").innerHTML = `
      <div class="top-meta">${shownCounts[en]}å›ç›® ï¼ˆç·å›æ•°: ${totalShown}ï¼‰</div>
      <div>${currentSentence.jp}</div>
    `;
    document.getElementById("sentence-en").innerText = currentSentence.en;
    document.getElementById("okBtn").disabled = false;

    // â˜… å‰å›è¡¨ç¤ºã‚’å…ˆé ­ã«ï¼ˆæ‹¬å¼§å†…ï¼‰è¡¨ç¤º â†’ ä»Šå›æ™‚åˆ»ã‚’ä¿å­˜
    const prevIso = lastShownMap[en];
    if (prevIso) {
      lastShownDiv.textContent = `ï¼ˆ${humanElapsed(prevIso)}ï¼‰${formatJp(prevIso)}`;
    } else {
      lastShownDiv.textContent = "ï¼ˆåˆå›è¡¨ç¤ºï¼‰";
    }
    lastShownMap[en] = new Date().toISOString();
    localStorage.setItem(keyPrefix + "lastShown", JSON.stringify(lastShownMap));
  }

  // âœ… YESãƒœã‚¿ãƒ³æŠ¼ä¸‹
  function confirmSentence() {
    if (!currentSentence) return;
    yesMarks[currentSentence.en] = true;
    localStorage.setItem(keyPrefix + "yesMarks", JSON.stringify(yesMarks));

    // ï¼ˆâ€» YESã—ã¦ã‚‚ remaining ã‚’æ¸›ã‚‰ã•ãªã„ã‚ˆã†ã«ã—ãŸã„å ´åˆã¯ã“ã“ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    remaining = remaining.filter(s => s !== currentSentence.en);
    localStorage.setItem(keyPrefix + "remaining", JSON.stringify(remaining));

    if (remaining.length > 0) {
      showRandom();
    } else {
      document.getElementById("sentence-jp").innerText = "ã™ã¹ã¦ã®è‹±æ–‡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
      document.getElementById("sentence-en").innerText = "";
      document.getElementById("last-shown").textContent = "";
      document.getElementById("showBtn").disabled = true;
      document.getElementById("okBtn").disabled = true;
    }
  }

  // âœ… ãƒªã‚»ãƒƒãƒˆå‡¦ç†
  function resetData() {
    if (!confirm("Reset all data?")) return;
    localStorage.removeItem(keyPrefix + "shownCounts");
    localStorage.removeItem(keyPrefix + "remaining");
    localStorage.removeItem(keyPrefix + "yesMarks");
    localStorage.removeItem(keyPrefix + "lastShown"); // å‰å›è¡¨ç¤ºæ™‚åˆ»ã‚‚æ¶ˆã™

    shownCounts = {};
    yesMarks = {};
    lastShownMap = {};
    remaining = allSentences.map(s => s.en);
    currentSentence = null;

    document.getElementById("sentence-jp").innerText = "Press 'Show Random' to start";
    document.getElementById("sentence-en").innerText = "";
    document.getElementById("last-shown").textContent = "";
    document.getElementById("showBtn").disabled = false;
    document.getElementById("statsArea").style.display = "none";
  }

  // âœ… çµ±è¨ˆè¡¨ç¤º
  function showStats() {
    const tbody = document.getElementById("statsBody");
    tbody.innerHTML = "";
    allSentences.forEach(s => {
      const count = shownCounts[s.en] || 0;
      const yes = yesMarks[s.en] ? "â—" : "â—‹";
      const row = `
        <tr>
          <td>${s.en}</td>
          <td>${s.jp}</td>
          <td style="text-align:center;">${yes}</td>
          <td style="text-align:center;">${count}</td>
        </tr>`;
      tbody.innerHTML += row;
    });
    document.getElementById("statsArea").style.display = "block";
  }

  // âœ… ãƒœã‚¿ãƒ³ç¾¤ã‚’ä¸Šä¸‹ã«ç§»å‹•ã™ã‚‹ãƒˆã‚°ãƒ«æ©Ÿèƒ½ï¼ˆã‚¹ãƒšãƒ¼ã‚µãƒ¼æ–¹å¼ï¼‰
  let isButtonTop = false;
  const moveBtn    = document.getElementById("moveToggleBtn");
  const buttonArea = document.getElementById("button-area");
  const spacer     = document.getElementById("button-spacer");

  function updateSpacerHeight() {
    const h = buttonArea.getBoundingClientRect().height;
    spacer.style.height = (h + 40) + "px"; // ãƒœã‚¿ãƒ³é«˜ã• + ä½™ç™½
  }

  function moveButtonsTop() {
    // ä½ç½®ã‚’ä¸Šã«
    buttonArea.style.top = "0";
    buttonArea.style.bottom = "";
    isButtonTop = true;
    moveBtn.textContent = "â¬‡ Move Buttons Down";

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåæ˜ å¾Œã«ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã®é«˜ã•ã‚’æ›´æ–°
    requestAnimationFrame(updateSpacerHeight);

    // ä¸‹å´ã®ä½™ç™½ã¯ä¸è¦
    document.body.style.paddingBottom = "0";
  }

  function moveButtonsBottom() {
    // ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã‚’0ã«æˆ»ã™
    spacer.style.height = "0";

    // ä½ç½®ã‚’ä¸‹ã«
    buttonArea.style.bottom = "30px";
    buttonArea.style.top = "";
    isButtonTop = false;
    moveBtn.textContent = "â¬† Move Buttons Up";

    // ä¸‹å´ä½™ç™½ã‚’å…ƒé€šã‚Š
    document.body.style.paddingBottom = "160px";
  }

  moveBtn.onclick = () => {
    if (isButtonTop) moveButtonsBottom();
    else moveButtonsTop();
  };

  // ãƒªã‚µã‚¤ã‚ºæ™‚ï¼šä¸Šé…ç½®ãªã‚‰ã‚¹ãƒšãƒ¼ã‚µãƒ¼å†è¨ˆç®—
  window.addEventListener("resize", () => {
    if (isButtonTop) updateSpacerHeight();
  });

  // åˆæœŸã¯ä¸‹é…ç½®
  moveButtonsBottom();

  // ====== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ======
  document.getElementById("showBtn").onclick = showRandom;
  document.getElementById("okBtn").onclick = confirmSentence;
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("statsBtn").onclick = showStats;
  document.getElementById("copyBtn").onclick = copyStats;
</script>
</body>
</html>
